This patch is based on the 4.6.0-mac branch of qt-kde on Gitorious.

  http://qt.gitorious.org/~rangerrick/qt/kde-qt-mac/commits/4.6.0-mac

It includes bugfixes from the KDE project, changes to allow building
of Qt/X11 on Mac OS X, and a few other miscellaneous changes that ease
packaging of KDE and Qt for the Fink project.

===
 README.kde-qt                                      |  201 ++++++++++++++++++++
 bin/syncqt                                         |    6 +-
 config.tests/unix/3dnow/3dnow.pro                  |    3 +-
 config.tests/unix/clock-gettime/clock-gettime.pro  |    3 +-
 .../unix/clock-monotonic/clock-monotonic.pro       |    3 +-
 config.tests/unix/cups/cups.pro                    |    3 +-
 config.tests/unix/db2/db2.pro                      |    3 +-
 config.tests/unix/dbus/dbus.pro                    |    3 +-
 .../unix/doubleformat/doubleformattest.pro         |    3 +-
 config.tests/unix/endian/endiantest.pro            |    3 +-
 config.tests/unix/floatmath/floatmath.pro          |    3 +-
 config.tests/unix/freetype/freetype.pro            |    2 +-
 config.tests/unix/getaddrinfo/getaddrinfo.pro      |    3 +-
 config.tests/unix/getifaddrs/getifaddrs.pro        |    3 +-
 config.tests/unix/glib/glib.pro                    |    2 +-
 config.tests/unix/gnu-libiconv/gnu-libiconv.pro    |    3 +-
 config.tests/unix/gstreamer/gstreamer.pro          |    2 +-
 config.tests/unix/ibase/ibase.pro                  |    3 +-
 config.tests/unix/iconv/iconv.pro                  |    1 +
 config.tests/unix/inotify/inotify.pro              |    3 +-
 config.tests/unix/ipv6/ipv6.pro                    |    3 +-
 config.tests/unix/ipv6ifname/ipv6ifname.pro        |    3 +-
 config.tests/unix/largefile/largefile.pro          |    3 +-
 config.tests/unix/libjpeg/libjpeg.pro              |    3 +-
 config.tests/unix/libmng/libmng.pro                |    3 +-
 config.tests/unix/libpng/libpng.pro                |    3 +-
 config.tests/unix/libtiff/libtiff.pro              |    3 +-
 config.tests/unix/mmx/mmx.pro                      |    3 +-
 config.tests/unix/mremap/mremap.pro                |    3 +-
 config.tests/unix/mysql/mysql.pro                  |    3 +-
 config.tests/unix/mysql_r/mysql_r.pro              |    3 +-
 config.tests/unix/nis/nis.pro                      |    3 +-
 config.tests/unix/oci/oci.pro                      |    3 +-
 config.tests/unix/odbc/odbc.pro                    |    3 +-
 config.tests/unix/openssl/openssl.pro              |    3 +-
 config.tests/unix/psql/psql.pro                    |    3 +-
 config.tests/unix/ptrsize/ptrsizetest.pro          |    3 +-
 config.tests/unix/sqlite/sqlite.pro                |    3 +-
 config.tests/unix/sqlite2/sqlite2.pro              |    3 +-
 config.tests/unix/sse/sse.pro                      |    3 +-
 config.tests/unix/sse2/sse2.pro                    |    3 +-
 config.tests/unix/stl/stl.pro                      |    3 +-
 config.tests/unix/tds/tds.pro                      |    3 +-
 config.tests/unix/tslib/tslib.pro                  |    2 +-
 config.tests/unix/zlib/zlib.pro                    |    3 +-
 config.tests/x11/opengl/opengl.pro                 |    2 +-
 configure                                          |   29 ++-
 configure-for-fink.sh                              |   57 ++++++
 mkspecs/common/mac.conf                            |    2 +-
 mkspecs/darwin-g++/qmake.conf                      |    7 +-
 projects.pro                                       |    3 +
 qmake/generators/mac/pbuilder_pbx.cpp              |    4 +-
 qmake/property.cpp                                 |   29 ++--
 src/3rdparty/webkit/WebKit/qt/Api/qwebpage.cpp     |    2 +-
 src/corelib/codecs/codecs.pri                      |    1 +
 src/corelib/codecs/qiconvcodec.cpp                 |    2 +-
 .../concurrent/qtconcurrentiteratekernel.cpp       |    4 +-
 src/corelib/corelib.pro                            |    2 +-
 src/corelib/global/qglobal.cpp                     |    2 +-
 src/corelib/global/qglobal.h                       |   21 ++-
 src/corelib/io/qfile.cpp                           |    4 +-
 src/corelib/io/qfilesystemwatcher.cpp              |    6 +-
 src/corelib/io/qfsfileengine_unix.cpp              |    2 +-
 src/corelib/io/qprocess.cpp                        |    2 +-
 src/corelib/io/qprocess_unix.cpp                   |    6 +-
 src/corelib/kernel/qcore_unix.cpp                  |    6 +-
 src/corelib/kernel/qeventdispatcher_unix.cpp       |    4 +-
 src/corelib/kernel/qeventdispatcher_unix_p.h       |    2 +-
 src/corelib/kernel/qobject.cpp                     |   10 +-
 src/corelib/kernel/qobject_p.h                     |    7 +-
 src/corelib/plugin/qlibrary.cpp                    |    2 +-
 src/corelib/plugin/qlibrary_unix.cpp               |    2 +-
 src/corelib/thread/qthread.cpp                     |    2 +-
 src/corelib/thread/qthread_unix.cpp                |    2 +-
 src/corelib/tools/qsharedpointer.cpp               |    2 +-
 src/corelib/xml/qxmlstream.cpp                     |    2 +-
 src/corelib/xml/qxmlstream.h                       |    2 +-
 src/gui/embedded/qlock.cpp                         |    6 +-
 src/gui/embedded/qscreenlinuxfb_qws.cpp            |    2 +-
 src/gui/embedded/qsoundqss_qws.h                   |    4 +-
 src/gui/embedded/qwindowsystem_qws.cpp             |    8 +-
 src/gui/kernel/qapplication_qws.cpp                |    2 +-
 src/gui/kernel/qeventdispatcher_mac.mm             |    2 +-
 src/gui/kernel/qkeymapper_mac.cpp                  |   14 +-
 src/gui/kernel/qkeysequence.cpp                    |   20 +-
 src/gui/kernel/qt_mac.cpp                          |    2 +-
 src/gui/kernel/qwidget_p.h                         |    1 +
 src/gui/kernel/qwidget_x11.cpp                     |   48 ++++--
 src/gui/painting/qdrawhelper_p.h                   |    2 +-
 src/gui/widgets/qtabbar.cpp                        |    2 +-
 src/multimedia/audio/qaudiodevicefactory.cpp       |   14 +-
 src/network/kernel/qhostinfo_unix.cpp              |    2 +-
 src/network/ssl/qsslsocket_openssl_symbols.cpp     |    2 +-
 src/qt3support/other/q3process_unix.cpp            |    4 +-
 src/qt3support/qt3support.pro                      |    1 +
 src/qt3support/text/q3textedit.cpp                 |    2 +-
 src/sql/drivers/odbc/qsql_odbc.h                   |    2 +-
 src/testlib/qbenchmark_p.h                         |    2 +-
 src/tools/moc/main.cpp                             |    6 +
 tests/auto/bic/tst_bic.cpp                         |    4 +-
 tests/auto/mediaobject/tst_mediaobject.cpp         |    2 +-
 tests/auto/q3dns/tst_q3dns.cpp                     |    2 +-
 .../qabstractitemview/tst_qabstractitemview.cpp    |    6 +-
 tests/auto/qfile/largefile/tst_largefile.cpp       |    4 +-
 tests/auto/qfile/tst_qfile.cpp                     |    4 +-
 tests/auto/qfiledialog/tst_qfiledialog.cpp         |    2 +-
 tests/auto/qfileinfo/tst_qfileinfo.cpp             |    2 +-
 tests/auto/qlibrary/tst_qlibrary.cpp               |    9 +-
 tests/auto/qplugin/tst_qplugin.cpp                 |    4 +-
 tests/auto/qpluginloader/tst_qpluginloader.cpp     |    4 +-
 tests/auto/qprinter/tst_qprinter.cpp               |    2 +-
 tests/auto/qsettings/tst_qsettings.cpp             |    8 +-
 tests/auto/qstring/tst_qstring.cpp                 |    6 +-
 .../auto/qstylesheetstyle/tst_qstylesheetstyle.cpp |    2 +-
 tests/auto/qtcpsocket/tst_qtcpsocket.cpp           |    2 +-
 tests/auto/qtimer/tst_qtimer.cpp                   |    2 +-
 .../lib/fulltextsearch/qclucene-config_p.h         |    2 +-
 tools/designer/src/plugins/plugins.pro             |    2 +
 118 files changed, 537 insertions(+), 240 deletions(-)

diff --git a/README.kde-qt b/README.kde-qt
new file mode 100644
index 0000000..db3feb6
--- /dev/null
+++ b/README.kde-qt
@@ -0,0 +1,201 @@
+This is a patched version of Qt.  It may include changes made by KDE
+and Qt developers that have either not been accepted for inclusion
+into Qt, or have been accepted for a later version of Qt than this
+one.
+
+1. Configuring Qt
+=================
+
+The recommended compile line is:
+
+--default-config-begin--
+
+  ./configure -qt-gif -debug -fast -no-separate-debug-info \
+     -system-libpng -system-libjpeg -system-zlib \
+     -dbus -webkit -plugin-sql-mysql \
+     -nomake examples -nomake demos -prefix <installdir>
+
+--default-config-end--
+
+It contains "-debug", which greatly improves the use for backtraces (but
+also needs a lot more disk space and makes things slower). To build in
+release mode, replace it with "-release".
+
+It also contains "-no-separate-debug-info", which disables separate .debug
+files. Instead, the debug information will be built into the libraries.
+This option is needed when you install Qt.
+
+If you don't install Qt, it can be useful to disable this option,
+thus having separate debug symbol files. With separate debug files, you can
+just move those debug files to another directory to remove Qt debug symbols.
+Moving the files back will enable Qt debug symbols again.
+This is useful if you rarely need to step into Qt functions during debugging,
+because GDB loads much faster and uses less memory without Qt debug symbols.
+In the rare case you need to step into Qt code, you can temporarily enable
+debug symbols again by moving the debug files back. You can even load the Qt
+debug symbols from within GDB on demand, using the "symbol-file" command.
+
+If you are planning to compile Qt using an Icecream cluster you have to
+pass the option -no-pch (no precompiled headers) to configure to make
+distributed compilation work.
+
+2. Compiling Qt
+===============
+
+To compile Qt on a Unix platform, run:
+
+   export MAKEFLAGS=-j2
+   make
+   make install
+
+If your computer has more than one core or processor, you may consider
+increasing the "2" above. If you've got a compile farm available, you
+should adjust the -j argument to match the number of slots in that
+farm.
+
+3. Modifying & rebuilding Qt
+============================
+
+If you make modifications to the Qt source code, you don't need to
+build everything again. Simply go to the directory containing the
+Makefile closest to the files you changed and run "make" again.
+
+For example, if you've modified src/corelib/io/qiodevice.cpp, do:
+
+   cd src/corelib
+   make
+
+If you make a change that is not temporary, you should create a Git
+commit out of it. However, you shouldn't push those changes to
+kde-qt.git. If you have a fix that benefit others, see the "Creating
+kde-qt.git modifications" section below.
+
+4. Building Qt examples and demos
+=================================
+
+The "-nomake examples -nomake demos" arguments to the configure script
+mean that those two sections will not be configured for building,
+which is unneeded for usage of the library.  If you want to compile
+the examples or demos later, just enter either directory and type:
+
+   qmake
+   make
+
+5. Build Qt tests
+=================
+
+(Official information: http://qt.gitorious.org/qt/pages/QtAutotestsEnvironment)
+
+In order to run Qt tests, you must have a "developer build" of Qt. For
+that, you need to reconfigure Qt and add the "-developer-build"
+option. That option is technically equivalent to the options:
+
+   -debug -prefix $PWD -DQT_BUILD_INTERNAL
+
+To run a test, go to its source dir in tests/auto/testname. Type
+"make" to build it, then run it (either ./tst_testname, or "make install").
+
+6. Building Qt documentation
+============================
+
+To build and install the documentation, run:
+
+   make docs
+   ./config.status
+   make install
+
+It is necessary to do this once only, even if you rebuild Qt later.
+
+7. Using Qt uninstalled
+=======================
+
+To use without having to install it, configure it as follows:
+
+   ./configure <other configure options>  -prefix $PWD
+   make sub-src
+   make sub-tools
+
+Attention: DO NOT run
+
+   make install
+
+If you do, Qt will overwrite your include/ directory with its
+installation.
+
+8. Creating kde-qt.git modifications
+====================================
+
+If you have fixed a bug in Qt or modified it in any way that may
+benefit others, please share your change in the form of a patch. Do
+not commit your changes directly to the main branch because they
+may be lost in a future update if they have not been added to the
+official Qt release.
+
+The exception to the above rule is that if the fix has been accepted
+by Qt Software (and so will appear in the very next release of Qt),
+then it should be simply cherry-picked from the Qt development
+branch. Note that you shouldn't do this for changes that have been
+accepted into a release which is not the very next.
+In this case, you should use the following command:
+
+   git cherry-pick -x SHA1_OF_THE_FIX
+where SHA1_OF_THE_FIX is the SHA-1 of the commit that you want to
+introduce. Then push the change to the server.
+
+Before creating a patch, it is recommended to contact Qt Software
+support via qt-bugs@trolltech.com and explain the situation. There may
+be a solution for the problem already or a new direction that should
+be accounted for.
+
+To create a patch, do the following:
+  a) look at the listing of branches in
+  http://qt.gitorious.org/+kde-developers/qt/kde-qt/commits/HEAD and
+  select the next number.
+
+  b) create a new branch out of a clean, released version of Qt, (for
+  example, 4.5.1), using the number above and a brief description of
+  your fix. For example:
+      git checkout -b patches/0180-window-role v4.5.1
+  You can see the available released versions of Qt with:
+      git tag
+
+  c) make your changes to the Qt source code and verify that it
+  compiles, links and works (please run the respective unit tests).
+
+  c) commit your changes to Git, using the "git commit" command. Please
+  see http://qt.gitorious.org/qt/pages/GitIntroductionWithQt and
+  http://qt.gitorious.org/qt/pages/QtCodingStyle for information on
+  how to create commits
+  Note that you can create multiple commits.
+
+  e) merge the change to the main branch, for example, 4.5.1-patched:
+      git checkout 4.5.1-patched
+      git merge patches/0180-window-role
+
+  f) push the changes you made to your branch and to the main server:
+      git push git@gitorious.org:qt/kde-qt.git 4.5.1-patched patches/0180-window-role
+  (Don't forget to list both branch names)
+
+Don't forget to submit your patch to using the Qt Contribution Model,
+along with the long description of the issue found. See
+http://qt.gitorious.org/qt/pages/QtContributionGuidelines for
+information how. You can submit the branch you've just sent to the
+server.
+
+9. Troubleshooting: Re-configuring and re-compiling
+==================================================
+
+For those updating the source in a directory where Qt has already
+been compiled, you may need to run the following commands from the
+top directory of your Qt sources:
+
+	find . -name '*.moc' | xargs rm
+
+Sometimes ./configure will refuse to run.  You may need to:
+	rm .qmake.cache
+
+If you think you may have run "make install" on an install-less Qt
+(srcdir == $QTDIR), run:
+
+	rm -rf include
+	bin/syncqt
diff --git a/bin/syncqt b/bin/syncqt
index a14a82d..ac140eb 100755
--- a/bin/syncqt
+++ b/bin/syncqt
@@ -366,9 +366,13 @@ sub fixPaths {
         $match_dir = $tmp;
         $i = $slash;
     }
+    my $cnt_ofs = 0;
+    if($match_dir =~ /^[a-zA-Z]:$/) {
+      $cnt_ofs = 1;
+    }
     if($match_dir) {
         my $after = substr($dir, length($match_dir));
-        my $count = ($after =~ tr,/,,);
+        my $count = ($after =~ tr,/,,) - $cnt_ofs;
         my $dots = "";
         for(my $i = 0; $i < $count; $i++) {
             $dots .= "../";
diff --git a/config.tests/unix/3dnow/3dnow.pro b/config.tests/unix/3dnow/3dnow.pro
index 90a8a19..791c5a3 100644
--- a/config.tests/unix/3dnow/3dnow.pro
+++ b/config.tests/unix/3dnow/3dnow.pro
@@ -1,3 +1,2 @@
 SOURCES = 3dnow.cpp
-CONFIG -= x11 qt
-mac:CONFIG -= app_bundle
+CONFIG -= x11 qt app_bundle
diff --git a/config.tests/unix/clock-gettime/clock-gettime.pro b/config.tests/unix/clock-gettime/clock-gettime.pro
index c527535..50ba344 100644
--- a/config.tests/unix/clock-gettime/clock-gettime.pro
+++ b/config.tests/unix/clock-gettime/clock-gettime.pro
@@ -1,4 +1,3 @@
 SOURCES = clock-gettime.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
 include(clock-gettime.pri)
diff --git a/config.tests/unix/clock-monotonic/clock-monotonic.pro b/config.tests/unix/clock-monotonic/clock-monotonic.pro
index 961e3a8..9e8c35f 100644
--- a/config.tests/unix/clock-monotonic/clock-monotonic.pro
+++ b/config.tests/unix/clock-monotonic/clock-monotonic.pro
@@ -1,4 +1,3 @@
 SOURCES = clock-monotonic.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
 include(../clock-gettime/clock-gettime.pri)
diff --git a/config.tests/unix/cups/cups.pro b/config.tests/unix/cups/cups.pro
index d7b78c8..7d8447a 100644
--- a/config.tests/unix/cups/cups.pro
+++ b/config.tests/unix/cups/cups.pro
@@ -1,4 +1,3 @@
 SOURCES = cups.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
 LIBS += -lcups
diff --git a/config.tests/unix/db2/db2.pro b/config.tests/unix/db2/db2.pro
index 0fa39a8..8ee9365 100644
--- a/config.tests/unix/db2/db2.pro
+++ b/config.tests/unix/db2/db2.pro
@@ -1,4 +1,3 @@
 SOURCES = db2.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
 LIBS += -ldb2
diff --git a/config.tests/unix/dbus/dbus.pro b/config.tests/unix/dbus/dbus.pro
index 1e4aea7..d307629 100644
--- a/config.tests/unix/dbus/dbus.pro
+++ b/config.tests/unix/dbus/dbus.pro
@@ -1,3 +1,2 @@
 SOURCES = dbus.cpp
-CONFIG -= qt
-mac:CONFIG -= app_bundle
+CONFIG -= qt app_bundle
diff --git a/config.tests/unix/doubleformat/doubleformattest.pro b/config.tests/unix/doubleformat/doubleformattest.pro
index 7e51dea..08284ee 100644
--- a/config.tests/unix/doubleformat/doubleformattest.pro
+++ b/config.tests/unix/doubleformat/doubleformattest.pro
@@ -1,3 +1,2 @@
 SOURCES = doubleformattest.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
diff --git a/config.tests/unix/endian/endiantest.pro b/config.tests/unix/endian/endiantest.pro
index 7b739eb..bab6273 100644
--- a/config.tests/unix/endian/endiantest.pro
+++ b/config.tests/unix/endian/endiantest.pro
@@ -1,3 +1,2 @@
 SOURCES = endiantest.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
diff --git a/config.tests/unix/floatmath/floatmath.pro b/config.tests/unix/floatmath/floatmath.pro
index 4c78563..7478b4d 100644
--- a/config.tests/unix/floatmath/floatmath.pro
+++ b/config.tests/unix/floatmath/floatmath.pro
@@ -1,3 +1,2 @@
 SOURCES = floatmath.cpp
-CONFIG -= x11 qt
-
+CONFIG -= x11 qt app_bundle
diff --git a/config.tests/unix/freetype/freetype.pro b/config.tests/unix/freetype/freetype.pro
index e84158e..afd7b6f 100644
--- a/config.tests/unix/freetype/freetype.pro
+++ b/config.tests/unix/freetype/freetype.pro
@@ -1,5 +1,5 @@
 SOURCES = freetype.cpp
 CONFIG += x11
-CONFIG -= qt
+CONFIG -= qt app_bundle
 LIBS += -lfreetype
 include(freetype.pri)
diff --git a/config.tests/unix/getaddrinfo/getaddrinfo.pro b/config.tests/unix/getaddrinfo/getaddrinfo.pro
index c9121db..af63815 100644
--- a/config.tests/unix/getaddrinfo/getaddrinfo.pro
+++ b/config.tests/unix/getaddrinfo/getaddrinfo.pro
@@ -1,4 +1,3 @@
 SOURCES = getaddrinfotest.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
 LIBS += $$QMAKE_LIBS_NETWORK
diff --git a/config.tests/unix/getifaddrs/getifaddrs.pro b/config.tests/unix/getifaddrs/getifaddrs.pro
index c3fead6..aa44091 100644
--- a/config.tests/unix/getifaddrs/getifaddrs.pro
+++ b/config.tests/unix/getifaddrs/getifaddrs.pro
@@ -1,5 +1,4 @@
 SOURCES = getifaddrs.cpp
-CONFIG -= qt
-mac:CONFIG -= app_bundle
+CONFIG -= qt app_bundle
 QT =
 LIBS += $$QMAKE_LIBS_NETWORK
diff --git a/config.tests/unix/glib/glib.pro b/config.tests/unix/glib/glib.pro
index 15d059d..c7cd53d 100644
--- a/config.tests/unix/glib/glib.pro
+++ b/config.tests/unix/glib/glib.pro
@@ -1,2 +1,2 @@
 SOURCES = glib.cpp
-CONFIG -= qt
+CONFIG -= qt app_bundle
diff --git a/config.tests/unix/gnu-libiconv/gnu-libiconv.pro b/config.tests/unix/gnu-libiconv/gnu-libiconv.pro
index d879b20..02ad928 100644
--- a/config.tests/unix/gnu-libiconv/gnu-libiconv.pro
+++ b/config.tests/unix/gnu-libiconv/gnu-libiconv.pro
@@ -1,4 +1,3 @@
 SOURCES = gnu-libiconv.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
 LIBS += -liconv
diff --git a/config.tests/unix/gstreamer/gstreamer.pro b/config.tests/unix/gstreamer/gstreamer.pro
index 7d4aa8e..29fc886 100644
--- a/config.tests/unix/gstreamer/gstreamer.pro
+++ b/config.tests/unix/gstreamer/gstreamer.pro
@@ -1,3 +1,3 @@
 SOURCES = gstreamer.cpp
-CONFIG -= qt
+CONFIG -= qt app_bundle
 LIBS += -lgstinterfaces-0.10 -lgstvideo-0.10 -lgstbase-0.10
diff --git a/config.tests/unix/ibase/ibase.pro b/config.tests/unix/ibase/ibase.pro
index 01e7429..f54130f 100644
--- a/config.tests/unix/ibase/ibase.pro
+++ b/config.tests/unix/ibase/ibase.pro
@@ -1,4 +1,3 @@
 SOURCES = ibase.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
 LIBS += -lgds
diff --git a/config.tests/unix/iconv/iconv.pro b/config.tests/unix/iconv/iconv.pro
index 8cdc776..336069b 100644
--- a/config.tests/unix/iconv/iconv.pro
+++ b/config.tests/unix/iconv/iconv.pro
@@ -1,3 +1,4 @@
 SOURCES = iconv.cpp
 CONFIG -= qt dylib app_bundle
 mac:LIBS += -liconv
+darwin-*:LIBS += -liconv
diff --git a/config.tests/unix/inotify/inotify.pro b/config.tests/unix/inotify/inotify.pro
index e2e1560..eea124e 100644
--- a/config.tests/unix/inotify/inotify.pro
+++ b/config.tests/unix/inotify/inotify.pro
@@ -1,3 +1,2 @@
 SOURCES = inotifytest.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
diff --git a/config.tests/unix/ipv6/ipv6.pro b/config.tests/unix/ipv6/ipv6.pro
index c51e61b..e0090f9 100644
--- a/config.tests/unix/ipv6/ipv6.pro
+++ b/config.tests/unix/ipv6/ipv6.pro
@@ -1,3 +1,2 @@
 SOURCES = ipv6test.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
diff --git a/config.tests/unix/ipv6ifname/ipv6ifname.pro b/config.tests/unix/ipv6ifname/ipv6ifname.pro
index ed62869..c15966a 100644
--- a/config.tests/unix/ipv6ifname/ipv6ifname.pro
+++ b/config.tests/unix/ipv6ifname/ipv6ifname.pro
@@ -1,5 +1,4 @@
 SOURCES = ipv6ifname.cpp
-CONFIG -= qt
-mac:CONFIG -= app_bundle
+CONFIG -= qt app_bundle
 QT =
 LIBS += $$QMAKE_LIBS_NETWORK
diff --git a/config.tests/unix/largefile/largefile.pro b/config.tests/unix/largefile/largefile.pro
index d7affc6..a466935 100644
--- a/config.tests/unix/largefile/largefile.pro
+++ b/config.tests/unix/largefile/largefile.pro
@@ -1,3 +1,2 @@
 SOURCES=largefiletest.cpp
-CONFIG-=qt dylib
-mac:CONFIG -= app_bundle
+CONFIG-=qt dylib app_bundle
diff --git a/config.tests/unix/libjpeg/libjpeg.pro b/config.tests/unix/libjpeg/libjpeg.pro
index d06888c..ad91bb8 100644
--- a/config.tests/unix/libjpeg/libjpeg.pro
+++ b/config.tests/unix/libjpeg/libjpeg.pro
@@ -1,4 +1,3 @@
 SOURCES = libjpeg.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
 LIBS += -ljpeg
diff --git a/config.tests/unix/libmng/libmng.pro b/config.tests/unix/libmng/libmng.pro
index ee57ecd..147e916 100644
--- a/config.tests/unix/libmng/libmng.pro
+++ b/config.tests/unix/libmng/libmng.pro
@@ -1,4 +1,3 @@
 SOURCES = libmng.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
 LIBS += -lmng
diff --git a/config.tests/unix/libpng/libpng.pro b/config.tests/unix/libpng/libpng.pro
index f038386..74e53e0 100644
--- a/config.tests/unix/libpng/libpng.pro
+++ b/config.tests/unix/libpng/libpng.pro
@@ -1,4 +1,3 @@
 SOURCES = libpng.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
 LIBS += -lpng
diff --git a/config.tests/unix/libtiff/libtiff.pro b/config.tests/unix/libtiff/libtiff.pro
index 60ba7d1..122bb83 100644
--- a/config.tests/unix/libtiff/libtiff.pro
+++ b/config.tests/unix/libtiff/libtiff.pro
@@ -1,4 +1,3 @@
 SOURCES = libtiff.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
 LIBS += -ltiff
diff --git a/config.tests/unix/mmx/mmx.pro b/config.tests/unix/mmx/mmx.pro
index d2fea7f..66352ae 100644
--- a/config.tests/unix/mmx/mmx.pro
+++ b/config.tests/unix/mmx/mmx.pro
@@ -1,3 +1,2 @@
 SOURCES = mmx.cpp
-CONFIG -= x11 qt
-mac:CONFIG -= app_bundle
+CONFIG -= x11 qt app_bundle
diff --git a/config.tests/unix/mremap/mremap.pro b/config.tests/unix/mremap/mremap.pro
index a36d756..7516e3b 100644
--- a/config.tests/unix/mremap/mremap.pro
+++ b/config.tests/unix/mremap/mremap.pro
@@ -1,3 +1,2 @@
 SOURCES = mremap.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
diff --git a/config.tests/unix/mysql/mysql.pro b/config.tests/unix/mysql/mysql.pro
index a22579e..ad7b9c9 100644
--- a/config.tests/unix/mysql/mysql.pro
+++ b/config.tests/unix/mysql/mysql.pro
@@ -1,4 +1,3 @@
 SOURCES = mysql.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
 LIBS += -lmysqlclient
diff --git a/config.tests/unix/mysql_r/mysql_r.pro b/config.tests/unix/mysql_r/mysql_r.pro
index 8c06067..1838533 100644
--- a/config.tests/unix/mysql_r/mysql_r.pro
+++ b/config.tests/unix/mysql_r/mysql_r.pro
@@ -1,4 +1,3 @@
 SOURCES = ../mysql/mysql.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
 LIBS += -lmysqlclient_r
diff --git a/config.tests/unix/nis/nis.pro b/config.tests/unix/nis/nis.pro
index 1f985b2..5d4fd2a 100644
--- a/config.tests/unix/nis/nis.pro
+++ b/config.tests/unix/nis/nis.pro
@@ -1,5 +1,4 @@
 SOURCES = nis.cpp
-CONFIG -= qt dylib
-mac: CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
 solaris-*:LIBS += -lnsl
 else:LIBS += $$QMAKE_LIBS_NIS
diff --git a/config.tests/unix/oci/oci.pro b/config.tests/unix/oci/oci.pro
index 4add225..eeccbea 100644
--- a/config.tests/unix/oci/oci.pro
+++ b/config.tests/unix/oci/oci.pro
@@ -1,4 +1,3 @@
 SOURCES = oci.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
 LIBS += -lclntsh
diff --git a/config.tests/unix/odbc/odbc.pro b/config.tests/unix/odbc/odbc.pro
index c588ede..f7a8766 100644
--- a/config.tests/unix/odbc/odbc.pro
+++ b/config.tests/unix/odbc/odbc.pro
@@ -1,4 +1,3 @@
 SOURCES = odbc.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
 LIBS += -lodbc
diff --git a/config.tests/unix/openssl/openssl.pro b/config.tests/unix/openssl/openssl.pro
index 6891e78..275af07 100644
--- a/config.tests/unix/openssl/openssl.pro
+++ b/config.tests/unix/openssl/openssl.pro
@@ -1,4 +1,3 @@
 SOURCES = openssl.cpp
-CONFIG -= x11 qt
-mac:CONFIG -= app_bundle
+CONFIG -= x11 qt app_bundle
 include(openssl.pri)
diff --git a/config.tests/unix/psql/psql.pro b/config.tests/unix/psql/psql.pro
index 64bb3d6..2227104 100644
--- a/config.tests/unix/psql/psql.pro
+++ b/config.tests/unix/psql/psql.pro
@@ -1,4 +1,3 @@
 SOURCES = psql.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
 LIBS += -lpq
diff --git a/config.tests/unix/ptrsize/ptrsizetest.pro b/config.tests/unix/ptrsize/ptrsizetest.pro
index 41aba86..e480bf4 100644
--- a/config.tests/unix/ptrsize/ptrsizetest.pro
+++ b/config.tests/unix/ptrsize/ptrsizetest.pro
@@ -1,3 +1,2 @@
 SOURCES = ptrsizetest.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
diff --git a/config.tests/unix/sqlite/sqlite.pro b/config.tests/unix/sqlite/sqlite.pro
index ba2cac1..62380f1 100644
--- a/config.tests/unix/sqlite/sqlite.pro
+++ b/config.tests/unix/sqlite/sqlite.pro
@@ -1,3 +1,2 @@
 SOURCES = sqlite.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
diff --git a/config.tests/unix/sqlite2/sqlite2.pro b/config.tests/unix/sqlite2/sqlite2.pro
index 14a64d5..e7bac94 100644
--- a/config.tests/unix/sqlite2/sqlite2.pro
+++ b/config.tests/unix/sqlite2/sqlite2.pro
@@ -1,4 +1,3 @@
 SOURCES = sqlite2.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
 LIBS += -lsqlite
diff --git a/config.tests/unix/sse/sse.pro b/config.tests/unix/sse/sse.pro
index 4cc34a7..7e09bc2 100644
--- a/config.tests/unix/sse/sse.pro
+++ b/config.tests/unix/sse/sse.pro
@@ -1,3 +1,2 @@
 SOURCES = sse.cpp
-CONFIG -= x11 qt
-mac:CONFIG -= app_bundle
+CONFIG -= x11 qt app_bundle
diff --git a/config.tests/unix/sse2/sse2.pro b/config.tests/unix/sse2/sse2.pro
index d4a21aa..8350c6b 100644
--- a/config.tests/unix/sse2/sse2.pro
+++ b/config.tests/unix/sse2/sse2.pro
@@ -1,3 +1,2 @@
 SOURCES = sse2.cpp
-CONFIG -= x11 qt
-mac:CONFIG -= app_bundle
+CONFIG -= x11 qt app_bundle
diff --git a/config.tests/unix/stl/stl.pro b/config.tests/unix/stl/stl.pro
index a2feab4..6b75323 100644
--- a/config.tests/unix/stl/stl.pro
+++ b/config.tests/unix/stl/stl.pro
@@ -1,3 +1,2 @@
 SOURCES = stltest.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
diff --git a/config.tests/unix/tds/tds.pro b/config.tests/unix/tds/tds.pro
index 5516a14..9e5ce70 100644
--- a/config.tests/unix/tds/tds.pro
+++ b/config.tests/unix/tds/tds.pro
@@ -1,4 +1,3 @@
 SOURCES = tds.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
 LIBS += -lsybdb
diff --git a/config.tests/unix/tslib/tslib.pro b/config.tests/unix/tslib/tslib.pro
index 1191120..825fe31 100644
--- a/config.tests/unix/tslib/tslib.pro
+++ b/config.tests/unix/tslib/tslib.pro
@@ -1,3 +1,3 @@
 SOURCES = tslib.cpp
-CONFIG -= qt 
+CONFIG -= qt app_bundle 
 LIBS += -lts
diff --git a/config.tests/unix/zlib/zlib.pro b/config.tests/unix/zlib/zlib.pro
index 67cc870..8460548 100644
--- a/config.tests/unix/zlib/zlib.pro
+++ b/config.tests/unix/zlib/zlib.pro
@@ -1,4 +1,3 @@
 SOURCES = zlib.cpp
-CONFIG -= qt dylib
-mac:CONFIG -= app_bundle
+CONFIG -= qt dylib app_bundle
 LIBS += -lz
diff --git a/config.tests/x11/opengl/opengl.pro b/config.tests/x11/opengl/opengl.pro
index 432bd8d..d2841f7 100644
--- a/config.tests/x11/opengl/opengl.pro
+++ b/config.tests/x11/opengl/opengl.pro
@@ -7,4 +7,4 @@ for(p, QMAKE_LIBDIR_OPENGL) {
 }
 
 CONFIG -= qt
-LIBS += -lGL -lGLU
+LIBS += -lGL -lGLU -Wl,-dylib_file,/System/Library/Frameworks/OpenGL.framework/Versions/A/Libraries/libGL.dylib:/System/Library/Frameworks/OpenGL.framework/Versions/A/Libraries/libGL.dylib
diff --git a/configure b/configure
index 146ba82..5c79204 100755
--- a/configure
+++ b/configure
@@ -165,6 +165,7 @@ UNAME_VERSION=`(uname -v) 2>/dev/null` || UNAME_VERSION=unknown
 #-------------------------------------------------------------------------------
 
 PLATFORM_X11=no
+PLATFORM_DARWIN=no
 PLATFORM_MAC=no
 PLATFORM_QWS=no
 
@@ -222,7 +223,7 @@ fi
 #-------------------------------------------------------------------------------
 # check the license
 #-------------------------------------------------------------------------------
-COMMERCIAL_USER=ask
+COMMERCIAL_USER=no
 CFG_DEV=no
 CFG_NOKIA=no
 CFG_EMBEDDED=no
@@ -1012,6 +1013,11 @@ while [ "$#" -gt 0 ]; do
             VAL=`echo $1 | sed 's,-D,,'`
         fi
         ;;
+    -isystem)
+        VAR="add_isystempath"
+        shift
+        VAL="$1"
+        ;;
     -I?*|-I)
         VAR="add_ipath"
         if [ "$1" = "-I" ]; then
@@ -1264,6 +1270,7 @@ while [ "$#" -gt 0 ]; do
     x11)
         if [ "$PLATFORM_MAC" = "yes" ]; then
             PLATFORM_MAC=no
+            PLATFORM_DARWIN=yes
         elif [ "$PLATFORM_QWS" = "yes" ]; then
             PLATFORM_QWS=no
         fi
@@ -2020,6 +2027,9 @@ while [ "$#" -gt 0 ]; do
     add_ipath)
         I_FLAGS="$I_FLAGS -I\"${VAL}\""
         ;;
+    add_isystempath)
+        I_FLAGS="$I_FLAGS -isystem \"${VAL}\""
+        ;;
     add_lpath)
         L_FLAGS="$L_FLAGS -L\"${VAL}\""
         ;;
@@ -2912,7 +2922,7 @@ else
 fi
 
 QMAKE_CONF_COMPILER=`getQMakeConf "$XQMAKESPEC" | grep "^QMAKE_CXX[^_A-Z0-9]" | sed "s,.* *= *\(.*\)$,\1," | tail -1`
-TEST_COMPILER="$CC"
+TEST_COMPILER="$CXX"
 [ -z "$TEST_COMPILER" ] && TEST_COMPILER=$QMAKE_CONF_COMPILER
 
 # auto-detect precompiled header support
@@ -4382,6 +4392,9 @@ if true; then ###[ '!' -f "$outpath/bin/qmake" ];
 		EXTRA_LFLAGS="$EXTRA_LFLAGS \$(SDK_LFLAGS)"
             fi
         fi
+	if [ "$PLATFORM_X11" = "yes" ] && [ "$PLATFORM_DARWIN" = "yes" ]; then
+	    EXTRA_CXXFLAGS="$EXTRA_CXXFLAGS -D__USE_WS_X11__"
+	fi
         [ "$CFG_EMBEDDED" != "no" ] && EXTRA_CFLAGS="$EXTRA_CFLAGS -DQWS"
         if [ '!' -z "$D_FLAGS" ]; then
             for DEF in $D_FLAGS; do
@@ -5359,7 +5372,7 @@ if [ "$PLATFORM_X11" = "yes" ]; then
 fi # X11
 
 
-if [ "$PLATFORM_MAC" = "yes" ]; then
+if [ "$PLATFORM_MAC" = "yes" ] || [ "$PLATFORM_DARWIN" = "yes" ]; then
     if [ "$CFG_PHONON" != "no" ]; then
         # Always enable Phonon (unless it was explicitly disabled)
         CFG_PHONON=yes
@@ -5502,7 +5515,7 @@ if [ "$CFG_LIBFREETYPE" = "auto" ]; then
 fi
 
 if [ "$CFG_ENDIAN" = "auto" ]; then
-    if [ "$PLATFORM_MAC" = "yes" ]; then
+    if [ "$PLATFORM_MAC" = "yes" ] || [ "$PLATFORM_DARWIN" = "yes" ]; then
 	true #leave as auto
     else
         "$unixtests/endian.test" "$XQMAKESPEC" $OPT_VERBOSE "$relpath" "$outpath"
@@ -5523,7 +5536,7 @@ if [ "$CFG_ENDIAN" = "auto" ]; then
 fi
 
 if [ "$CFG_HOST_ENDIAN" = "auto" ]; then
-    if [ "$PLATFORM_MAC" = "yes" ]; then
+    if [ "$PLATFORM_MAC" = "yes" ] || [ "$PLATFORM_DARWIN" = "yes" ]; then
 	true #leave as auto
     else
         "$unixtests/endian.test" "$QMAKESPEC" $OPT_VERBOSE "$relpath" "$outpath"
@@ -6167,7 +6180,7 @@ else
     QT_CONFIG="$QT_CONFIG freetype"
 fi
 
-if [ "x$PLATFORM_MAC" = "xyes" ]; then
+if [ "x$PLATFORM_MAC" = "xyes" ] || [ "x$PLATFORM_DARWIN" = "xyes" ]; then
     #On Mac we implicitly link against libz, so we
     #never use the 3rdparty stuff.
     [ "$CFG_ZLIB" = "yes" ] && CFG_ZLIB="system"
@@ -6247,7 +6260,7 @@ fi
 [ '!' -z "$L_FLAGS" ] && QMakeVar add QMAKE_LIBDIR_FLAGS "$L_FLAGS"
 [ '!' -z "$l_FLAGS" ] && QMakeVar add LIBS "$l_FLAGS"
 
-if [ "$PLATFORM_MAC" = "yes" ]; then
+if [ "$PLATFORM_MAC" = "yes" ] || [ "$PLATFORM_DARWIN" = "yes" ]; then
     if [ "$CFG_RPATH" = "yes" ]; then
        QMAKE_CONFIG="$QMAKE_CONFIG absolute_library_soname"
     fi
@@ -6852,7 +6865,7 @@ if [ "$CFG_FRAMEWORK" = "yes" ]; then
     echo "#define QT_MAC_FRAMEWORK_BUILD" >>"$outpath/src/corelib/global/qconfig.h.new"
 fi
 
-if [ "$PLATFORM_MAC" = "yes" ]; then
+if [ "$PLATFORM_MAC" = "yes" ] || [ "$PLATFORM_DARWIN" = "yes" ]; then
     cat >>"$outpath/src/corelib/global/qconfig.h.new" <<EOF
 #if defined(__LP64__)
 # define QT_POINTER_SIZE 8
diff --git a/configure-for-fink.sh b/configure-for-fink.sh
new file mode 100755
index 0000000..58e09ef
--- /dev/null
+++ b/configure-for-fink.sh
@@ -0,0 +1,57 @@
+#!/bin/sh -e
+
+MYDIR=`dirname $0`
+TOPDIR=`cd $MYDIR; pwd`
+
+FINKPREFIX="$1"; shift
+PKGNAME="$1"; shift
+
+if [ -z "$FINKPREFIX" ] || [ -z "$PKGNAME" ]; then
+	echo "usage: $0 <fink_prefix> <pkgname>"
+	exit 1
+fi
+
+QTDIR=`pwd`
+PATH="$QTDIR/bin:$FINKPREFIX/lib/freetype219/bin:$PATH"
+
+EXTRA_ARGS=""
+
+[ -z "$CC"  ] && CC=gcc-4.0
+[ -z "$CXX" ] && CXX=g++-4.0
+
+if [ "$PKGNAME" = "qt4-x11" ]; then
+	EXTRA_ARGS="-x11 -platform darwin-g++ -xplatform darwin-g++"
+else
+	EXTRA_ARGS="-platform macx-g++ -xplatform macx-g++"
+fi
+
+case `sw_vers -productVersion` in
+	10.[01234]*)
+		;;
+	*)
+		LDFLAGS="$LDFLAGS -Wl,-dead_strip_dylibs"
+		;;
+esac
+
+export FINKPREFIX QTDIR PATH LIBRESOLV CC CXX EXTRA_ARGS LDFLAGS
+
+echo "yes" | sh $TOPDIR/configure \
+	"-I$FINKPREFIX/lib/system-openssl/include" "-L$FINKPREFIX/lib/system-openssl/lib" \
+	"-I$FINKPREFIX/lib/freetype219/include" "-I$FINKPREFIX/lib/freetype219/include/freetype2" "-L$FINKPREFIX/lib/freetype219/lib" \
+	"-I$FINKPREFIX/lib/fontconfig2/include" "-I$FINKPREFIX/lib/fontconfig2/include" "-L$FINKPREFIX/lib/fontconfig2/lib" \
+	"-I$FINKPREFIX/include" -isystem /usr/X11R6/include "-L$FINKPREFIX/lib" "-L/usr/X11R6/lib" \
+	-prefix "$FINKPREFIX/lib/$PKGNAME" -docdir "$FINKPREFIX/share/doc/$PKGNAME" \
+	-no-fast -webkit -openssl-linked -reduce-exports \
+	-exceptions -qt-gif -system-freetype -phonon -phonon-backend \
+	-no-sql-ibase -no-sql-mysql -no-sql-odbc -no-sql-psql \
+	-plugin-sql-sqlite -dbus-linked $EXTRA_ARGS "$@"
+
+# don't link against older versions of self
+/usr/bin/find . -name Makefile -print0 | xargs -0 perl -pi -e "s,-L$FINKPREFIX/lib/$PKGNAME/lib,,g"
+
+# attempt to counterfix qmake's warped fileFixify logic that makes install break
+# when $FINKPREFIX is a symlink and something exists already at -libdir or -datadir etc
+pushd $FINKPREFIX;
+	FixifiedSW=`/bin/pwd`;
+popd
+/usr/bin/find . -name Makefile -print0 | xargs -0 perl -pi -e "s,\\$\\(INSTALL_ROOT\\)$FixifiedSW,\\$\\(INSTALL_ROOT\\)$FINKPREFIX,g"
diff --git a/mkspecs/common/mac.conf b/mkspecs/common/mac.conf
index 5d88ac4..ca58917 100644
--- a/mkspecs/common/mac.conf
+++ b/mkspecs/common/mac.conf
@@ -17,7 +17,7 @@ QMAKE_FIX_RPATH         = install_name_tool -id
 QMAKE_RPATH		=
 
 QMAKE_LIBS_DYNLOAD	=
-QMAKE_LIBS_OPENGL	= -framework OpenGL -framework AGL
+QMAKE_LIBS_OPENGL	= -framework OpenGL -framework AGL -Wl,-dylib_file,/System/Library/Frameworks/OpenGL.framework/Versions/A/Libraries/libGL.dylib:/System/Library/Frameworks/OpenGL.framework/Versions/A/Libraries/libGL.dylib
 QMAKE_LIBS_OPENGL_QT	= $$QMAKE_LIBS_OPENGL
 QMAKE_LIBS_THREAD	=
 
diff --git a/mkspecs/darwin-g++/qmake.conf b/mkspecs/darwin-g++/qmake.conf
index 72baa89..4b02ed0 100644
--- a/mkspecs/darwin-g++/qmake.conf
+++ b/mkspecs/darwin-g++/qmake.conf
@@ -6,7 +6,7 @@
 
 MAKEFILE_GENERATOR	= UNIX
 TEMPLATE		= app
-CONFIG			+= qt warn_on release link_prl native_precompiled_headers
+CONFIG			+= qt warn_on release lib_version_first link_prl native_precompiled_headers
 QT			+= core gui
 DEFINES                 += __USE_WS_X11__
 
@@ -69,12 +69,13 @@ QMAKE_LFLAGS_VERSION    = -current_version$${LITERAL_WHITESPACE}
 QMAKE_LFLAGS_COMPAT_VERSION = -compatibility_version$${LITERAL_WHITESPACE}
 
 QMAKE_RPATH		=
+QMAKE_FIX_RPATH		= install_name_tool -id 
 
 QMAKE_LIBS_DYNLOAD	=
 QMAKE_LIBS_X11		= -lXext -lX11 -lm
 QMAKE_LIBS_X11SM	= -lSM -lICE
-QMAKE_LIBS_OPENGL	= -lGLU -lGL
-QMAKE_LIBS_OPENGL_QT	= -lGL
+QMAKE_LIBS_OPENGL	= -lGLU -lGL -Wl,-dylib_file,/System/Library/Frameworks/OpenGL.framework/Versions/A/Libraries/libGL.dylib:/System/Library/Frameworks/OpenGL.framework/Versions/A/Libraries/libGL.dylib
+QMAKE_LIBS_OPENGL_QT	= -lGL -Wl,-dylib_file,/System/Library/Frameworks/OpenGL.framework/Versions/A/Libraries/libGL.dylib:/System/Library/Frameworks/OpenGL.framework/Versions/A/Libraries/libGL.dylib
 QMAKE_LIBS_THREAD	=
 
 QMAKE_MOC		= $$[QT_INSTALL_BINS]/moc
diff --git a/projects.pro b/projects.pro
index aa1eb71..8ae64c2 100644
--- a/projects.pro
+++ b/projects.pro
@@ -149,6 +149,9 @@ unix {
    DEFAULT_QMAKESPEC ~= s,^.*mkspecs/,,g
    mkspecs.commands += $(DEL_FILE) $(INSTALL_ROOT)$$mkspecs.path/default; $(SYMLINK) $$DEFAULT_QMAKESPEC $(INSTALL_ROOT)$$mkspecs.path/default
 }
+win32 {
+   mkspecs.files += $$QT_BUILD_TREE/mkspecs/default
+}
 INSTALLS += mkspecs
 
 false:macx { #mac install location
diff --git a/qmake/generators/mac/pbuilder_pbx.cpp b/qmake/generators/mac/pbuilder_pbx.cpp
index 488d8d0..1c21110 100644
--- a/qmake/generators/mac/pbuilder_pbx.cpp
+++ b/qmake/generators/mac/pbuilder_pbx.cpp
@@ -52,7 +52,7 @@
 #  include <sys/types.h>
 #  include <sys/stat.h>
 #endif
-#ifdef Q_OS_DARWIN
+#ifdef Q_OS_MAC
 #include <ApplicationServices/ApplicationServices.h>
 #include <private/qcore_mac_p.h>
 #endif
@@ -1689,7 +1689,7 @@ ProjectBuilderMakefileGenerator::pbuilderVersion() const
     } else {
         QString version, version_plist = project->first("QMAKE_PBUILDER_VERSION_PLIST");
         if(version_plist.isEmpty()) {
-#ifdef Q_OS_DARWIN
+#ifdef Q_OS_MAC
             ret = QLatin1String("34");
             QCFType<CFURLRef> cfurl;
             OSStatus err = LSFindApplicationForInfo(0, CFSTR("com.apple.Xcode"), 0, 0, &cfurl);
diff --git a/qmake/property.cpp b/qmake/property.cpp
index ea4842a..ac54854 100644
--- a/qmake/property.cpp
+++ b/qmake/property.cpp
@@ -81,29 +81,32 @@ QMakeProperty::keyBase(bool version) const
 QString
 QMakeProperty::value(QString v, bool just_check)
 {
+    QString ret;
     if(v == "QT_INSTALL_PREFIX")
-        return QLibraryInfo::location(QLibraryInfo::PrefixPath);
+        ret = QLibraryInfo::location(QLibraryInfo::PrefixPath);
     else if(v == "QT_INSTALL_DATA")
-        return QLibraryInfo::location(QLibraryInfo::DataPath);
+        ret = QLibraryInfo::location(QLibraryInfo::DataPath);
     else if(v == "QT_INSTALL_DOCS")
-        return QLibraryInfo::location(QLibraryInfo::DocumentationPath);
+        ret = QLibraryInfo::location(QLibraryInfo::DocumentationPath);
     else if(v == "QT_INSTALL_HEADERS")
-        return QLibraryInfo::location(QLibraryInfo::HeadersPath);
+        ret = QLibraryInfo::location(QLibraryInfo::HeadersPath);
     else if(v == "QT_INSTALL_LIBS")
-        return QLibraryInfo::location(QLibraryInfo::LibrariesPath);
+        ret = QLibraryInfo::location(QLibraryInfo::LibrariesPath);
     else if(v == "QT_INSTALL_BINS")
-        return QLibraryInfo::location(QLibraryInfo::BinariesPath);
+        ret = QLibraryInfo::location(QLibraryInfo::BinariesPath);
     else if(v == "QT_INSTALL_PLUGINS")
-        return QLibraryInfo::location(QLibraryInfo::PluginsPath);
+        ret = QLibraryInfo::location(QLibraryInfo::PluginsPath);
     else if(v == "QT_INSTALL_TRANSLATIONS")
-        return QLibraryInfo::location(QLibraryInfo::TranslationsPath);
+        ret = QLibraryInfo::location(QLibraryInfo::TranslationsPath);
     else if(v == "QT_INSTALL_CONFIGURATION")
-        return QLibraryInfo::location(QLibraryInfo::SettingsPath);
+        ret = QLibraryInfo::location(QLibraryInfo::SettingsPath);
     else if(v == "QT_INSTALL_EXAMPLES")
-        return QLibraryInfo::location(QLibraryInfo::ExamplesPath);
+        ret = QLibraryInfo::location(QLibraryInfo::ExamplesPath);
     else if(v == "QT_INSTALL_DEMOS")
-        return QLibraryInfo::location(QLibraryInfo::DemosPath);
-    else if(v == "QMAKE_MKSPECS")
+        ret = QLibraryInfo::location(QLibraryInfo::DemosPath);
+    if(!ret.isEmpty())
+        return QDir::toNativeSeparators(ret);
+    if(v == "QMAKE_MKSPECS")
         return qmake_mkspec_paths().join(Option::target_mode == Option::TARG_WIN_MODE ? ";" : ":");
     else if(v == "QMAKE_VERSION")
         return qmake_version();
@@ -116,7 +119,7 @@ QMakeProperty::value(QString v, bool just_check)
     int slash = v.lastIndexOf('/');
     QVariant var = settings->value(keyBase(slash == -1) + v);
     bool ok = var.isValid();
-    QString ret = var.toString();
+    ret = var.toString();
     if(!ok) {
         QString version = qmake_version();
         if(slash != -1) {
diff --git a/src/3rdparty/webkit/WebKit/qt/Api/qwebpage.cpp b/src/3rdparty/webkit/WebKit/qt/Api/qwebpage.cpp
index aedf95a..13736af 100644
--- a/src/3rdparty/webkit/WebKit/qt/Api/qwebpage.cpp
+++ b/src/3rdparty/webkit/WebKit/qt/Api/qwebpage.cpp
@@ -3097,7 +3097,7 @@ QString QWebPage::userAgentForUrl(const QUrl& url) const
     "AIX"
 #elif defined Q_OS_WIN32
     "%2"
-#elif defined Q_OS_DARWIN
+#elif defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
 #ifdef __i386__ || __x86_64__
     "Intel Mac OS X"
 #else
diff --git a/src/corelib/codecs/codecs.pri b/src/corelib/codecs/codecs.pri
index 17f4d91..7dfec12 100644
--- a/src/corelib/codecs/codecs.pri
+++ b/src/corelib/codecs/codecs.pri
@@ -25,6 +25,7 @@ unix {
         contains(QT_CONFIG,iconv) {
                 HEADERS += codecs/qiconvcodec_p.h
                 SOURCES += codecs/qiconvcodec.cpp
+                LIBS += -liconv
         } else:contains(QT_CONFIG,gnu-libiconv) {
                 HEADERS += codecs/qiconvcodec_p.h
                 SOURCES += codecs/qiconvcodec.cpp
diff --git a/src/corelib/codecs/qiconvcodec.cpp b/src/corelib/codecs/qiconvcodec.cpp
index bbfb6ed..d055919 100644
--- a/src/corelib/codecs/qiconvcodec.cpp
+++ b/src/corelib/codecs/qiconvcodec.cpp
@@ -62,7 +62,7 @@
 #elif defined(Q_OS_AIX)
 #  define NO_BOM
 #  define UTF16 "UCS-2"
-#elif defined(Q_OS_FREEBSD) || defined(Q_OS_MAC)
+#elif defined(Q_OS_FREEBSD) || defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
 #  define NO_BOM
 #  if Q_BYTE_ORDER == Q_BIG_ENDIAN
 #    define UTF16 "UTF-16BE"
diff --git a/src/corelib/concurrent/qtconcurrentiteratekernel.cpp b/src/corelib/concurrent/qtconcurrentiteratekernel.cpp
index 2d3663b..680e491 100644
--- a/src/corelib/concurrent/qtconcurrentiteratekernel.cpp
+++ b/src/corelib/concurrent/qtconcurrentiteratekernel.cpp
@@ -41,7 +41,7 @@
 
 #include "qtconcurrentiteratekernel.h"
 
-#if defined(Q_OS_MAC)
+#if defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
 #include <mach/mach.h>
 #include <mach/mach_time.h>
 #include <unistd.h>
@@ -64,7 +64,7 @@ enum {
     MedianSize = 7
 };
 
-#if defined(Q_OS_MAC)
+#if defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
 
 static qint64 getticks()
 {
diff --git a/src/corelib/corelib.pro b/src/corelib/corelib.pro
index 9a15bf1..aaea7ec 100644
--- a/src/corelib/corelib.pro
+++ b/src/corelib/corelib.pro
@@ -18,7 +18,7 @@ include(codecs/codecs.pri)
 include(statemachine/statemachine.pri)
 include(xml/xml.pri)
 
-mac|darwin:LIBS_PRIVATE += -framework ApplicationServices
+mac:LIBS_PRIVATE += -framework ApplicationServices
 
 mac:lib_bundle:DEFINES += QT_NO_DEBUG_PLUGIN_CHECK
 win32:DEFINES-=QT_NO_CAST_TO_ASCII
diff --git a/src/corelib/global/qglobal.cpp b/src/corelib/global/qglobal.cpp
index 541aa2b..4b3123b 100644
--- a/src/corelib/global/qglobal.cpp
+++ b/src/corelib/global/qglobal.cpp
@@ -1259,7 +1259,7 @@ bool qSharedBuild()
     \macro Q_OS_DARWIN
     \relates <QtGlobal>
 
-    Defined on Darwin OS (synonym for Q_OS_MAC).
+    Defined on Darwin OS.
 */
 
 /*!
diff --git a/src/corelib/global/qglobal.h b/src/corelib/global/qglobal.h
index c9ad6e2..5da4bc1 100644
--- a/src/corelib/global/qglobal.h
+++ b/src/corelib/global/qglobal.h
@@ -128,7 +128,7 @@ namespace QT_NAMESPACE {}
 
 #endif /* __cplusplus */
 
-#if defined(Q_OS_MAC) && !defined(Q_CC_INTEL)
+#if ( defined(Q_OS_DARWIN) || defined(Q_OS_MAC) ) && !defined(Q_CC_INTEL)
 #define QT_BEGIN_HEADER extern "C++" {
 #define QT_END_HEADER }
 #define QT_BEGIN_INCLUDE_HEADER }
@@ -143,7 +143,7 @@ namespace QT_NAMESPACE {}
 /*
    The operating system, must be one of: (Q_OS_x)
 
-     DARWIN   - Darwin OS (synonym for Q_OS_MAC)
+     DARWIN   - Darwin OS (pure Darwin or Mac OS X using X11)
      SYMBIAN  - Symbian
      MSDOS    - MS-DOS and Windows
      OS2      - OS/2
@@ -265,12 +265,15 @@ namespace QT_NAMESPACE {}
 #  define Q_OS_WIN
 #endif
 
-#if defined(Q_OS_DARWIN)
+#if defined(Q_OS_DARWIN) && !defined(__USE_WS_X11__)
+#  undef Q_OS_DARWIN
 #  define Q_OS_MAC /* Q_OS_MAC is mostly for compatibility, but also more clear */
 #  define Q_OS_MACX /* Q_OS_MACX is only for compatibility.*/
 #  if defined(Q_OS_DARWIN64)
+#     undef Q_OS_DARWIN64
 #     define Q_OS_MAC64
 #  elif defined(Q_OS_DARWIN32)
+#     undef Q_OS_DARWIN32
 #     define Q_OS_MAC32
 #  endif
 #endif
@@ -294,11 +297,11 @@ namespace QT_NAMESPACE {}
 #  define Q_OS_UNIX
 #endif
 
-#if defined(Q_OS_DARWIN) && !defined(QT_LARGEFILE_SUPPORT)
+#if ( defined(Q_OS_DARWIN) || defined(Q_OS_MAC) ) && !defined(QT_LARGEFILE_SUPPORT)
 #  define QT_LARGEFILE_SUPPORT 64
 #endif
 
-#ifdef Q_OS_DARWIN
+#if defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
 #  ifdef MAC_OS_X_VERSION_MIN_REQUIRED
 #    undef MAC_OS_X_VERSION_MIN_REQUIRED
 #  endif
@@ -485,7 +488,7 @@ namespace QT_NAMESPACE {}
 #    define Q_NO_TEMPLATE_FRIENDS
 #  endif
 /* Apple's GCC 3.1 chokes on our streaming qDebug() */
-#  if defined(Q_OS_DARWIN) && __GNUC__ == 3 && (__GNUC_MINOR__ >= 1 && __GNUC_MINOR__ < 3)
+#  if ( defined(Q_OS_DARWIN) || defined(Q_OS_MAC) ) && __GNUC__ == 3 && (__GNUC_MINOR__ >= 1 && __GNUC_MINOR__ < 3)
 #    define Q_BROKEN_DEBUG_STREAM
 #  endif
 #  if (defined(Q_CC_GNU) || defined(Q_CC_INTEL)) && !defined(QT_MOC_CPP)
@@ -804,7 +807,7 @@ namespace QT_NAMESPACE {}
 #  define Q_WS_PM
 #  error "Qt does not work with OS/2 Presentation Manager or Workplace Shell"
 #elif defined(Q_OS_UNIX)
-#  if defined(Q_OS_MAC) && !defined(__USE_WS_X11__) && !defined(Q_WS_QWS)
+#  if defined(Q_OS_MAC) && !defined(Q_WS_QWS)
 #    define Q_WS_MAC
 #    define Q_WS_MACX
 #    if defined(Q_OS_MAC64)
@@ -1463,7 +1466,7 @@ public:
     static WinVersion windowsVersion();
 
 #endif
-#ifdef Q_OS_MAC
+#if defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
     enum MacVersion {
         MV_Unknown = 0x0000,
 
@@ -2076,7 +2079,7 @@ Q_DECLARE_TYPEINFO(qint64, Q_PRIMITIVE_TYPE);
 Q_DECLARE_TYPEINFO(quint64, Q_PRIMITIVE_TYPE);
 Q_DECLARE_TYPEINFO(float, Q_PRIMITIVE_TYPE);
 Q_DECLARE_TYPEINFO(double, Q_PRIMITIVE_TYPE);
-#ifndef Q_OS_DARWIN
+#if !defined(Q_OS_DARWIN) && !defined(Q_OS_MAC)
 Q_DECLARE_TYPEINFO(long double, Q_PRIMITIVE_TYPE);
 #endif
 
diff --git a/src/corelib/io/qfile.cpp b/src/corelib/io/qfile.cpp
index bcd5dbc..30b6746 100644
--- a/src/corelib/io/qfile.cpp
+++ b/src/corelib/io/qfile.cpp
@@ -62,7 +62,7 @@ static const int QFILE_WRITEBUFFER_SIZE = 16384;
 
 static QByteArray locale_encode(const QString &f)
 {
-#ifndef Q_OS_DARWIN
+#if !defined(Q_OS_DARWIN) && !defined(Q_OS_MAC)
     return f.toLocal8Bit();
 #else
     // Mac always expects UTF-8... and decomposed...
@@ -72,7 +72,7 @@ static QByteArray locale_encode(const QString &f)
 
 static QString locale_decode(const QByteArray &f)
 {
-#ifndef Q_OS_DARWIN
+#if !defined(Q_OS_DARWIN) && !defined(Q_OS_MAC)
     return QString::fromLocal8Bit(f);
 #else
     // Mac always gives us UTF-8 and decomposed, we want that composed...
diff --git a/src/corelib/io/qfilesystemwatcher.cpp b/src/corelib/io/qfilesystemwatcher.cpp
index c810f44..7fc7749 100644
--- a/src/corelib/io/qfilesystemwatcher.cpp
+++ b/src/corelib/io/qfilesystemwatcher.cpp
@@ -57,8 +57,8 @@
 #elif defined(Q_OS_LINUX)
 #  include "qfilesystemwatcher_inotify_p.h"
 #  include "qfilesystemwatcher_dnotify_p.h"
-#elif defined(Q_OS_FREEBSD) || defined(Q_OS_MAC)
-#  if (defined Q_OS_MAC) && (MAC_OS_X_VERSION_MAX_ALLOWED >= MAC_OS_X_VERSION_10_5)
+#elif defined(Q_OS_FREEBSD) || defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
+#  if ( (defined Q_OS_DARWIN || defined Q_OS_MAC) ) && (MAC_OS_X_VERSION_MAX_ALLOWED >= MAC_OS_X_VERSION_10_5)
 #  include "qfilesystemwatcher_fsevents_p.h"
 #  endif //MAC_OS_X_VERSION_MAX_ALLOWED >= MAC_OS_X_VERSION_10_5)
 #  include "qfilesystemwatcher_kqueue_p.h"
@@ -247,7 +247,7 @@ QFileSystemWatcherEngine *QFileSystemWatcherPrivate::createNativeEngine()
     if(!eng)
         eng = QDnotifyFileSystemWatcherEngine::create();
     return eng;
-#elif defined(Q_OS_FREEBSD) || defined(Q_OS_MAC)
+#elif defined(Q_OS_FREEBSD) || defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
 #  if 0 && (defined Q_OS_MAC) && (MAC_OS_X_VERSION_MAX_ALLOWED >= MAC_OS_X_VERSION_10_5)
     if (QSysInfo::MacintoshVersion >= QSysInfo::MV_10_5)
         return QFSEventsFileSystemWatcherEngine::create();
diff --git a/src/corelib/io/qfsfileengine_unix.cpp b/src/corelib/io/qfsfileengine_unix.cpp
index 5fd7834..806058b 100644
--- a/src/corelib/io/qfsfileengine_unix.cpp
+++ b/src/corelib/io/qfsfileengine_unix.cpp
@@ -480,7 +480,7 @@ bool QFSFileEngine::mkdir(const QString &name, bool createParentDirectories) con
         }
         return true;
     }
-#if defined(Q_OS_DARWIN)  // Mac X doesn't support trailing /'s
+#if defined(Q_OS_DARWIN) || defined(Q_OS_MAC) // Mac X doesn't support trailing /'s
     if (dirName.endsWith(QLatin1Char('/')))
         dirName.chop(1);
 #endif
diff --git a/src/corelib/io/qprocess.cpp b/src/corelib/io/qprocess.cpp
index 7ef590e..7f14d01 100644
--- a/src/corelib/io/qprocess.cpp
+++ b/src/corelib/io/qprocess.cpp
@@ -2165,7 +2165,7 @@ bool QProcess::startDetached(const QString &program)
 }
 
 QT_BEGIN_INCLUDE_NAMESPACE
-#ifdef Q_OS_MAC
+#if defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
 # include <crt_externs.h>
 # define environ (*_NSGetEnviron())
 #elif defined(Q_OS_WINCE) || defined(Q_OS_SYMBIAN)
diff --git a/src/corelib/io/qprocess_unix.cpp b/src/corelib/io/qprocess_unix.cpp
index 3a2edf8..96956a0 100644
--- a/src/corelib/io/qprocess_unix.cpp
+++ b/src/corelib/io/qprocess_unix.cpp
@@ -471,7 +471,7 @@ static char **_q_dupEnvironment(const QHash<QByteArray, QByteArray> &environment
     // if LD_LIBRARY_PATH exists in the current environment, but
     // not in the environment list passed by the programmer, then
     // copy it over.
-#if defined(Q_OS_MAC)
+#if defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
     static const char libraryPath[] = "DYLD_LIBRARY_PATH";
 #else
     static const char libraryPath[] = "LD_LIBRARY_PATH";
@@ -584,7 +584,7 @@ void QProcessPrivate::startProcess()
     // Add every argument to the list
     for (int i = 0; i < arguments.count(); ++i) {
         QString arg = arguments.at(i);
-#ifdef Q_OS_MAC
+#if defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
         // Mac OS X uses UTF8 for exec, regardless of the system locale.
         argv[i + 1] = ::strdup(arg.toUtf8().constData());
 #else
@@ -1207,7 +1207,7 @@ bool QProcessPrivate::startDetached(const QString &program, const QStringList &a
 
             char **argv = new char *[arguments.size() + 2];
             for (int i = 0; i < arguments.size(); ++i) {
-#ifdef Q_OS_MAC
+#if defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
                 argv[i + 1] = ::strdup(arguments.at(i).toUtf8().constData());
 #else
                 argv[i + 1] = ::strdup(arguments.at(i).toLocal8Bit().constData());
diff --git a/src/corelib/kernel/qcore_unix.cpp b/src/corelib/kernel/qcore_unix.cpp
index b984922..c8122ce 100644
--- a/src/corelib/kernel/qcore_unix.cpp
+++ b/src/corelib/kernel/qcore_unix.cpp
@@ -50,7 +50,7 @@
 
 #include <stdlib.h>
 
-#ifdef Q_OS_MAC
+#if defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
 #include <mach/mach_time.h>
 #endif
 
@@ -64,7 +64,7 @@ QT_BEGIN_NAMESPACE
 
 bool qt_gettime_is_monotonic()
 {
-#if (_POSIX_MONOTONIC_CLOCK-0 > 0) || defined(Q_OS_MAC)
+#if (_POSIX_MONOTONIC_CLOCK-0 > 0) || defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
     return true;
 #else
     static int returnValue = 0;
@@ -86,7 +86,7 @@ bool qt_gettime_is_monotonic()
 timeval qt_gettime()
 {
     timeval tv;
-#if defined(Q_OS_MAC)
+#if defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
     static mach_timebase_info_data_t info = {0,0};
     if (info.denom == 0)
         mach_timebase_info(&info);
diff --git a/src/corelib/kernel/qeventdispatcher_unix.cpp b/src/corelib/kernel/qeventdispatcher_unix.cpp
index 8147c22..aa948d5 100644
--- a/src/corelib/kernel/qeventdispatcher_unix.cpp
+++ b/src/corelib/kernel/qeventdispatcher_unix.cpp
@@ -313,7 +313,7 @@ QTimerInfoList::QTimerInfoList()
 {
     currentTime = qt_gettime();
 
-#if (_POSIX_MONOTONIC_CLOCK-0 <= 0) && !defined(Q_OS_MAC)
+#if (_POSIX_MONOTONIC_CLOCK-0 <= 0) && !defined(Q_OS_DARWIN) && !defined(Q_OS_MAC)
     if (!qt_gettime_is_monotonic()) {
         // not using monotonic timers, initialize the timeChanged() machinery
         previousTime = currentTime;
@@ -340,7 +340,7 @@ timeval QTimerInfoList::updateCurrentTime()
     return (currentTime = qt_gettime());
 }
 
-#if ((_POSIX_MONOTONIC_CLOCK-0 <= 0) && !defined(Q_OS_MAC)) || defined(QT_BOOTSTRAPPED)
+#if ((_POSIX_MONOTONIC_CLOCK-0 <= 0) && !defined(Q_OS_MAC) && !defined(Q_OS_MAC)) || defined(QT_BOOTSTRAPPED)
 
 template <>
 timeval qAbs(const timeval &t)
diff --git a/src/corelib/kernel/qeventdispatcher_unix_p.h b/src/corelib/kernel/qeventdispatcher_unix_p.h
index 838c270..26f0759 100644
--- a/src/corelib/kernel/qeventdispatcher_unix_p.h
+++ b/src/corelib/kernel/qeventdispatcher_unix_p.h
@@ -82,7 +82,7 @@ struct QTimerInfo {
 
 class QTimerInfoList : public QList<QTimerInfo*>
 {
-#if ((_POSIX_MONOTONIC_CLOCK-0 <= 0) && !defined(Q_OS_MAC)) || defined(QT_BOOTSTRAPPED)
+#if ((_POSIX_MONOTONIC_CLOCK-0 <= 0) && !defined(Q_OS_DARWIN) && !defined(Q_OS_MAC)) || defined(QT_BOOTSTRAPPED)
     timeval previousTime;
     clock_t previousTicks;
     int ticksPerSecond;
diff --git a/src/corelib/kernel/qobject.cpp b/src/corelib/kernel/qobject.cpp
index 9614e7a..77a11d6 100644
--- a/src/corelib/kernel/qobject.cpp
+++ b/src/corelib/kernel/qobject.cpp
@@ -1136,8 +1136,16 @@ void QObject::setObjectName(const QString &name)
 {
     Q_D(QObject);
     d->objectName = name;
+#if defined(Q_WS_X11)
+    d->checkWindowRole();
+#endif
 }
 
+#if defined(Q_WS_X11)
+void QObjectPrivate::checkWindowRole()
+{
+}
+#endif
 
 #ifdef QT3_SUPPORT
 /*! \internal
@@ -1490,7 +1498,7 @@ void QObject::moveToThread(QThread *targetThread)
                  "Cannot move to target thread (%p)\n",
                  d->threadData->thread, currentData->thread, targetData->thread);
 
-#ifdef Q_WS_MAC
+#if defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
         qWarning("On Mac OS X, you might be loading two sets of Qt binaries into the same process. "
                  "Check that all plugins are compiled against the right Qt binaries. Export "
                  "DYLD_PRINT_LIBRARIES=1 and check that only one set of binaries are being loaded.");
diff --git a/src/corelib/kernel/qobject_p.h b/src/corelib/kernel/qobject_p.h
index e75f24e..1294fa4 100644
--- a/src/corelib/kernel/qobject_p.h
+++ b/src/corelib/kernel/qobject_p.h
@@ -83,7 +83,9 @@ void Q_CORE_EXPORT qt_register_signal_spy_callbacks(const QSignalSpyCallbackSet
 
 extern QSignalSpyCallbackSet Q_CORE_EXPORT qt_signal_spy_callback_set;
 
-enum { QObjectPrivateVersion = QT_VERSION };
+// add 0x1000000 to mark it as qt-copy version, with possible modifications
+// in some Q*Private class
+enum { QObjectPrivateVersion = QT_VERSION + 0x1000000 };
 
 class Q_CORE_EXPORT QDeclarativeData
 {
@@ -157,6 +159,9 @@ public:
     void sendPendingChildInsertedEvents();
     void removePendingChildInsertedEvents(QObject *child);
 #endif
+#if defined(Q_WS_X11)
+    virtual void checkWindowRole();
+#endif
 
     static Sender *setCurrentSender(QObject *receiver,
                                     Sender *sender);
diff --git a/src/corelib/plugin/qlibrary.cpp b/src/corelib/plugin/qlibrary.cpp
index 1669654..b2e988b 100644
--- a/src/corelib/plugin/qlibrary.cpp
+++ b/src/corelib/plugin/qlibrary.cpp
@@ -556,7 +556,7 @@ bool QLibrary::isLibrary(const QString &fileName)
     if (completeSuffix.isEmpty())
         return false;
     QStringList suffixes = completeSuffix.split(QLatin1Char('.'));
-# if defined(Q_OS_DARWIN)
+# if defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
 
     // On Mac, libs look like libmylib.1.0.0.dylib
     const QString lastSuffix = suffixes.at(suffixes.count() - 1);
diff --git a/src/corelib/plugin/qlibrary_unix.cpp b/src/corelib/plugin/qlibrary_unix.cpp
index 8f73c91..83a7035 100644
--- a/src/corelib/plugin/qlibrary_unix.cpp
+++ b/src/corelib/plugin/qlibrary_unix.cpp
@@ -143,7 +143,7 @@ bool QLibraryPrivate::load_sys()
             suffixes << QLatin1String(".so");
         }
 #endif
-# ifdef Q_OS_MAC
+# if defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
         if (!fullVersion.isEmpty()) {
             suffixes << QString::fromLatin1(".%1.bundle").arg(fullVersion);
             suffixes << QString::fromLatin1(".%1.dylib").arg(fullVersion);
diff --git a/src/corelib/thread/qthread.cpp b/src/corelib/thread/qthread.cpp
index a7c2a16..bde66f3 100644
--- a/src/corelib/thread/qthread.cpp
+++ b/src/corelib/thread/qthread.cpp
@@ -64,7 +64,7 @@
 /*
 #  elif defined(Q_OS_HPUX)
 #   include <sys/pstat.h>
-#  elif defined(Q_OS_FREEBSD) || defined(Q_OS_OPENBSD) || defined(Q_OS_MAC)
+#  elif defined(Q_OS_FREEBSD) || defined(Q_OS_OPENBSD) || defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
 #   include <sys/sysctl.h>
 #  endif
 #endif
diff --git a/src/corelib/thread/qthread_unix.cpp b/src/corelib/thread/qthread_unix.cpp
index 100a836..5173173 100644
--- a/src/corelib/thread/qthread_unix.cpp
+++ b/src/corelib/thread/qthread_unix.cpp
@@ -657,7 +657,7 @@ void QThread::setPriority(Priority priority)
 
     // copied from start() with a few modifications:
 
-#if defined(Q_OS_DARWIN) || !defined(Q_OS_OPENBSD) && defined(_POSIX_THREAD_PRIORITY_SCHEDULING) && (_POSIX_THREAD_PRIORITY_SCHEDULING-0 >= 0)
+#if defined(Q_OS_DARWIN) || defined(Q_OS_MAC) || ( !defined(Q_OS_OPENBSD) && defined(_POSIX_THREAD_PRIORITY_SCHEDULING) && (_POSIX_THREAD_PRIORITY_SCHEDULING-0 >= 0) )
     int sched_policy;
     sched_param param;
 
diff --git a/src/corelib/tools/qsharedpointer.cpp b/src/corelib/tools/qsharedpointer.cpp
index c684dc5..5c852f7 100644
--- a/src/corelib/tools/qsharedpointer.cpp
+++ b/src/corelib/tools/qsharedpointer.cpp
@@ -1281,7 +1281,7 @@ QT_END_NAMESPACE
 #  ifdef QT_SHARED_POINTER_BACKTRACE_SUPPORT
 #    if defined(__GLIBC__) && (__GLIBC__ >= 2) && !defined(__UCLIBC__) && !defined(QT_LINUXBASE)
 #      define BACKTRACE_SUPPORTED
-#    elif defined(Q_OS_MACX)
+#    elif defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
 #      define BACKTRACE_SUPPORTED
 #    endif
 #  endif
diff --git a/src/corelib/xml/qxmlstream.cpp b/src/corelib/xml/qxmlstream.cpp
index c2e2eda..5a5f26c 100644
--- a/src/corelib/xml/qxmlstream.cpp
+++ b/src/corelib/xml/qxmlstream.cpp
@@ -41,7 +41,7 @@
 
 #include "QtCore/qxmlstream.h"
 
-#if defined(QT_BUILD_XML_LIB) && defined(Q_OS_MAC64)
+#if defined(QT_BUILD_XML_LIB) && (defined(Q_OS_DARWIN64) || defined(Q_OS_MAC64))
 // No need to define this in the 64-bit Mac libraries.
 // Since Qt 4.4 and previous weren't supported in 64-bit, there are
 // no QXmlStream* symbols to keep compatibility with
diff --git a/src/corelib/xml/qxmlstream.h b/src/corelib/xml/qxmlstream.h
index 786e1cc..3a6c885 100644
--- a/src/corelib/xml/qxmlstream.h
+++ b/src/corelib/xml/qxmlstream.h
@@ -85,7 +85,7 @@ QT_MODULE(Core)
 // We are taking the optimist scenario here to avoid creating more
 // symbols to be supported.
 
-#if defined(Q_OS_MAC32) || defined(Q_OS_AIX)
+#if defined(Q_OS_DARWIN32) || defined(Q_OS_MAC32) || defined(Q_OS_AIX)
 # if !defined QT_BUILD_XML_LIB
 #  define Q_XMLSTREAM_RENAME_SYMBOLS
 # endif
diff --git a/src/gui/embedded/qlock.cpp b/src/gui/embedded/qlock.cpp
index 170c259..54f43d2 100644
--- a/src/gui/embedded/qlock.cpp
+++ b/src/gui/embedded/qlock.cpp
@@ -86,11 +86,11 @@ QT_END_NAMESPACE
 
 #include <unistd.h>
 #include <sys/types.h>
-#if defined(Q_OS_DARWIN)
+#if defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
 #   define Q_NO_SEMAPHORE
 #   include <sys/stat.h>
 #   include <sys/file.h>
-#else // Q_OS_DARWIN
+#else // Q_OS_DARWIN || Q_OS_MAC
 #   include <sys/sem.h>
 #   if (defined(__GNU_LIBRARY__) && !defined(_SEM_SEMUN_UNDEFINED) && !defined(QT_LINUXBASE)) \
     || defined(Q_OS_FREEBSD) || defined(Q_OS_OPENBSD) || defined(Q_OS_NETBSD) \
@@ -104,7 +104,7 @@ union semun {
     unsigned short *array;      /* array for GETALL, SETALL */
 };
 #   endif
-#endif // Q_OS_DARWIN
+#endif // Q_OS_DARWIN || Q_OS_MAC
 #include <sys/ipc.h>
 #include <string.h>
 #include <errno.h>
diff --git a/src/gui/embedded/qscreenlinuxfb_qws.cpp b/src/gui/embedded/qscreenlinuxfb_qws.cpp
index f3fd7cb..71417ee 100644
--- a/src/gui/embedded/qscreenlinuxfb_qws.cpp
+++ b/src/gui/embedded/qscreenlinuxfb_qws.cpp
@@ -63,7 +63,7 @@
 
 #include "qwindowsystem_qws.h"
 
-#if !defined(Q_OS_DARWIN) && !defined(Q_OS_FREEBSD)
+#if !defined(Q_OS_DARWIN) && !defined(Q_OS_MAC) && !defined(Q_OS_FREEBSD)
 #include <linux/fb.h>
 
 #ifdef __i386__
diff --git a/src/gui/embedded/qsoundqss_qws.h b/src/gui/embedded/qsoundqss_qws.h
index e8a14df..de4fd63 100644
--- a/src/gui/embedded/qsoundqss_qws.h
+++ b/src/gui/embedded/qsoundqss_qws.h
@@ -60,7 +60,7 @@ QT_MODULE(Gui)
 #define QT_NO_QWS_SOUNDSERVER
 #endif
 
-#ifndef Q_OS_MAC
+#if !defined(Q_OS_DARWIN) && !defined(Q_OS_MAC)
 
 class QWSSoundServerPrivate;
 
@@ -166,7 +166,7 @@ Q_SIGNALS:
 };
 #endif
 
-#endif // Q_OS_MAC
+#endif // !Q_OS_DARWIN && !Q_OS_MAC
 
 QT_END_NAMESPACE
 
diff --git a/src/gui/embedded/qwindowsystem_qws.cpp b/src/gui/embedded/qwindowsystem_qws.cpp
index 7526b98..41e9127 100644
--- a/src/gui/embedded/qwindowsystem_qws.cpp
+++ b/src/gui/embedded/qwindowsystem_qws.cpp
@@ -94,7 +94,7 @@
 #include <sys/mount.h>
 #endif
 
-#if !defined(QT_NO_SOUND) && !defined(Q_OS_DARWIN)
+#if !defined(QT_NO_SOUND) && !defined(Q_OS_DARWIN) && !defined(Q_OS_MAC)
 #ifdef QT_USE_OLD_QWS_SOUND
 #include <sys/types.h>
 #include <sys/stat.h>
@@ -1445,7 +1445,7 @@ void QWSServerPrivate::initServer(int flags)
     }
 #endif
 
-#if !defined(QT_NO_SOUND) && !defined(QT_EXTERNAL_SOUND_SERVER) && !defined(Q_OS_DARWIN)
+#if !defined(QT_NO_SOUND) && !defined(QT_EXTERNAL_SOUND_SERVER) && !defined(Q_OS_DARWIN) && !defined(Q_OS_MAC)
     soundserver = new QWSSoundServer(q);
 #endif
 }
@@ -1977,7 +1977,7 @@ void QWSServerPrivate::doClient(QWSClient *client)
         case QWSCommand::GrabKeyboard:
             invokeGrabKeyboard((QWSGrabKeyboardCommand*)cs->command, cs->client);
             break;
-#if !defined(QT_NO_SOUND) && !defined(Q_OS_DARWIN)
+#if !defined(QT_NO_SOUND) && !defined(Q_OS_DARWIN) && !defined(Q_OS_MAC)
         case QWSCommand::PlaySound:
             invokePlaySound((QWSPlaySoundCommand*)cs->command, cs->client);
             break;
@@ -3200,7 +3200,7 @@ void QWSServerPrivate::invokeGrabKeyboard(QWSGrabKeyboardCommand *cmd, QWSClient
 #if !defined(QT_NO_SOUND)
 void QWSServerPrivate::invokePlaySound(QWSPlaySoundCommand *cmd, QWSClient *)
 {
-#if !defined(QT_EXTERNAL_SOUND_SERVER) && !defined(Q_OS_DARWIN)
+#if !defined(QT_EXTERNAL_SOUND_SERVER) && !defined(Q_OS_DARWIN) && !defined(Q_OS_MAC)
     soundserver->playFile( 1, cmd->filename );
 #else
     Q_UNUSED(cmd);
diff --git a/src/gui/kernel/qapplication_qws.cpp b/src/gui/kernel/qapplication_qws.cpp
index 00f24d7..a7cb94a 100644
--- a/src/gui/kernel/qapplication_qws.cpp
+++ b/src/gui/kernel/qapplication_qws.cpp
@@ -116,7 +116,7 @@
 #ifdef QT_NO_QSHM
 #include <sys/ipc.h>
 #include <sys/shm.h>
-#ifndef Q_OS_DARWIN
+#if !defined(Q_OS_DARWIN) && !defined(Q_OS_MAC)
 # include <sys/sem.h>
 #endif
 #include <sys/socket.h>
diff --git a/src/gui/kernel/qeventdispatcher_mac.mm b/src/gui/kernel/qeventdispatcher_mac.mm
index 52d4c6f..defd8ac 100644
--- a/src/gui/kernel/qeventdispatcher_mac.mm
+++ b/src/gui/kernel/qeventdispatcher_mac.mm
@@ -125,7 +125,7 @@ static inline CFRunLoopRef mainRunLoop()
 void QEventDispatcherMacPrivate::activateTimer(CFRunLoopTimerRef, void *info)
 {
     int timerID =
-#ifdef Q_OS_MAC64
+#if defined(Q_OS_DARWIN64) || defined(Q_OS_MAC64)
     qint64(info);
 #else
     int(info);
diff --git a/src/gui/kernel/qkeymapper_mac.cpp b/src/gui/kernel/qkeymapper_mac.cpp
index 15da0b9..2c8a428 100644
--- a/src/gui/kernel/qkeymapper_mac.cpp
+++ b/src/gui/kernel/qkeymapper_mac.cpp
@@ -396,7 +396,7 @@ static Boolean qt_KeyEventComparatorProc(EventRef inEvent, void *data)
 static bool translateKeyEventInternal(EventHandlerCallRef er, EventRef keyEvent, int *qtKey,
                                       QChar *outChar, Qt::KeyboardModifiers *outModifiers, bool *outHandled)
 {
-#if !defined(QT_MAC_USE_COCOA) || defined(Q_OS_MAC64)
+#if !defined(QT_MAC_USE_COCOA) || defined(Q_OS_DARWIN64) || defined(Q_OS_MAC64)
     Q_UNUSED(er);
     Q_UNUSED(outHandled);
 #endif
@@ -421,7 +421,7 @@ static bool translateKeyEventInternal(EventHandlerCallRef er, EventRef keyEvent,
     //get mac mapping
     static UInt32 tmp_unused_state = 0L;
     const UCKeyboardLayout *uchrData = 0;
-#if defined(Q_OS_MAC32)
+#if defined(Q_OS_DARWIN32) || defined(Q_OS_MAC32)
     KeyboardLayoutRef keyLayoutRef = 0;
     KLGetCurrentKeyboardLayout(&keyLayoutRef);
     OSStatus err;
@@ -481,7 +481,7 @@ static bool translateKeyEventInternal(EventHandlerCallRef er, EventRef keyEvent,
                      long(err), __FILE__, __LINE__);
         }
     }
-#ifdef Q_OS_MAC32
+#if defined(Q_OS_DARWIN32) || defined(Q_OS_MAC32)
     else {
         // The road less travelled; use KeyTranslate
         const void *keyboard_layout;
@@ -554,7 +554,7 @@ QKeyMapperPrivate::QKeyMapperPrivate()
 {
     memset(keyLayout, 0, sizeof(keyLayout));
     keyboard_layout_format.unicode = 0;
-#ifdef Q_OS_MAC32
+#if defined(Q_OS_DARWIN32) || defined(Q_OS_MAC32)
     keyboard_mode = NullMode;
 #else
     currentInputSource = 0;
@@ -570,7 +570,7 @@ bool
 QKeyMapperPrivate::updateKeyboard()
 {
     const UCKeyboardLayout *uchrData = 0;
-#ifdef Q_OS_MAC32
+#if defined(Q_OS_DARWIN32) || defined(Q_OS_MAC32)
     KeyboardLayoutRef keyLayoutRef = 0;
     KLGetCurrentKeyboardLayout(&keyLayoutRef);
 
@@ -602,7 +602,7 @@ QKeyMapperPrivate::updateKeyboard()
         keyboard_layout_format.unicode = uchrData;
         keyboard_mode = UnicodeMode;
     }
-#ifdef Q_OS_MAC32
+#if defined(Q_OS_DARWIN32) || defined(Q_OS_MAC32)
     else {
         void *happy;
         err = KLGetKeyboardLayoutProperty(keyLayoutRef, kKLKCHRData,
@@ -621,7 +621,7 @@ QKeyMapperPrivate::updateKeyboard()
 #endif
     keyboard_dead = 0;
     CFStringRef iso639Code;
-#ifdef Q_OS_MAC32
+#if defined(Q_OS_DARWIN32) || defined(Q_OS_MAC32)
 # ifndef kKLLanguageCode
 # define kKLLanguageCode 9
 # endif
diff --git a/src/gui/kernel/qkeysequence.cpp b/src/gui/kernel/qkeysequence.cpp
index 528d512..edbe75b 100644
--- a/src/gui/kernel/qkeysequence.cpp
+++ b/src/gui/kernel/qkeysequence.cpp
@@ -1139,10 +1139,10 @@ int QKeySequencePrivate::decodeString(const QString &str, QKeySequence::Sequence
 
     QList<QModifKeyName> modifs;
     if (nativeText) {
-        modifs << QModifKeyName(Qt::CTRL, QShortcut::tr("Ctrl").toLower().append(QLatin1Char('+')))
-               << QModifKeyName(Qt::SHIFT, QShortcut::tr("Shift").toLower().append(QLatin1Char('+')))
-               << QModifKeyName(Qt::ALT, QShortcut::tr("Alt").toLower().append(QLatin1Char('+')))
-               << QModifKeyName(Qt::META, QShortcut::tr("Meta").toLower().append(QLatin1Char('+')));
+        modifs << QModifKeyName(Qt::CTRL, QShortcut::tr("Ctrl", "Ctrl key, used for shortcuts").toLower().append(QLatin1Char('+')))
+               << QModifKeyName(Qt::SHIFT, QShortcut::tr("Shift", "Shift key, used for shortcuts").toLower().append(QLatin1Char('+')))
+               << QModifKeyName(Qt::ALT, QShortcut::tr("Alt", "Alt key, used for shortcuts").toLower().append(QLatin1Char('+')))
+               << QModifKeyName(Qt::META, QShortcut::tr("Meta", "Meta key, used for shortcuts").toLower().append(QLatin1Char('+')));
     }
     modifs += *gmodifs; // Test non-translated ones last
 
@@ -1232,7 +1232,7 @@ QString QKeySequence::encodeString(int key)
 static inline void addKey(QString &str, const QString &theKey, QKeySequence::SequenceFormat format)
 {
     if (!str.isEmpty())
-        str += (format == QKeySequence::NativeText) ? QShortcut::tr("+")
+        str += (format == QKeySequence::NativeText) ? QShortcut::tr("+", "Symbol used to concatenate keys in shortcuts")
                                                     : QString::fromLatin1("+");
     str += theKey;
 }
@@ -1272,13 +1272,13 @@ QString QKeySequencePrivate::encodeString(int key, QKeySequence::SequenceFormat
     {
         // On other systems the order is Meta, Control, Alt, Shift
         if ((key & Qt::META) == Qt::META)
-            s = nativeText ? QShortcut::tr("Meta") : QString::fromLatin1("Meta");
+            s = nativeText ? QShortcut::tr("Meta", "Meta key, used for shortcuts") : QString::fromLatin1("Meta");
         if ((key & Qt::CTRL) == Qt::CTRL)
-            addKey(s, nativeText ? QShortcut::tr("Ctrl") : QString::fromLatin1("Ctrl"), format);
+            addKey(s, nativeText ? QShortcut::tr("Ctrl", "Ctrl key, used for shortcuts") : QString::fromLatin1("Ctrl"), format);
         if ((key & Qt::ALT) == Qt::ALT)
-            addKey(s, nativeText ? QShortcut::tr("Alt") : QString::fromLatin1("Alt"), format);
+            addKey(s, nativeText ? QShortcut::tr("Alt", "Alt key, used for shortcuts") : QString::fromLatin1("Alt"), format);
         if ((key & Qt::SHIFT) == Qt::SHIFT)
-            addKey(s, nativeText ? QShortcut::tr("Shift") : QString::fromLatin1("Shift"), format);
+            addKey(s, nativeText ? QShortcut::tr("Shift", "Shift key, used for shortcuts") : QString::fromLatin1("Shift"), format);
     }
 
 
@@ -1293,7 +1293,7 @@ QString QKeySequencePrivate::encodeString(int key, QKeySequence::SequenceFormat
             p += QChar((key-0x10000)%400+0xdc00);
         }
     } else if (key >= Qt::Key_F1 && key <= Qt::Key_F35) {
-            p = nativeText ? QShortcut::tr("F%1").arg(key - Qt::Key_F1 + 1)
+            p = nativeText ? QShortcut::tr("F%1", "Fx key, used for shortcuts").arg(key - Qt::Key_F1 + 1)
                            : QString::fromLatin1("F%1").arg(key - Qt::Key_F1 + 1);
     } else if (key) {
         int i=0;
diff --git a/src/gui/kernel/qt_mac.cpp b/src/gui/kernel/qt_mac.cpp
index 20f24ce..1d287e1 100644
--- a/src/gui/kernel/qt_mac.cpp
+++ b/src/gui/kernel/qt_mac.cpp
@@ -128,7 +128,7 @@ QColor qcolorForTheme(ThemeBrush brush)
 
 QColor qcolorForThemeTextColor(ThemeTextColor themeColor)
 {
-#ifdef Q_OS_MAC32
+#if defined(Q_OS_DARWIN32) || defined(Q_OS_MAC32)
     RGBColor c;
     GetThemeTextColor(themeColor, 32, true, &c);
     QColor color = QColor(c.red / 256, c.green / 256, c.blue / 256);
diff --git a/src/gui/kernel/qwidget_p.h b/src/gui/kernel/qwidget_p.h
index 7832393..18c331a 100644
--- a/src/gui/kernel/qwidget_p.h
+++ b/src/gui/kernel/qwidget_p.h
@@ -661,6 +661,7 @@ public:
     static QWidget *keyboardGrabber;
 
     void setWindowRole();
+    virtual void checkWindowRole();
     void sendStartupMessage(const char *message) const;
     void setNetWmWindowTypes();
     void x11UpdateIsOpaque();
diff --git a/src/gui/kernel/qwidget_x11.cpp b/src/gui/kernel/qwidget_x11.cpp
index 3135ece..5c997a4 100644
--- a/src/gui/kernel/qwidget_x11.cpp
+++ b/src/gui/kernel/qwidget_x11.cpp
@@ -763,6 +763,11 @@ void QWidgetPrivate::create_sys(WId window, bool initializeWindow, bool destroyO
         Q_ASSERT(id);
         XChangeWindowAttributes(dpy, id, CWOverrideRedirect | CWSaveUnder,
                                 &wsa);
+        XClassHint class_hint;
+        QByteArray appName = qAppName().toLatin1();
+        class_hint.res_name = appName.data(); // application name
+        class_hint.res_class = const_cast<char *>(QX11Info::appClass());   // application class
+        XSetWMProperties(dpy, id, 0, 0, 0, 0, 0, 0, &class_hint);
     } else if (topLevel && !desktop) {        // top-level widget
         if (!X11->wm_client_leader)
             create_wm_client_leader();
@@ -816,32 +821,40 @@ void QWidgetPrivate::create_sys(WId window, bool initializeWindow, bool destroyO
         // set EWMH window types
         setNetWmWindowTypes();
 
+        // when we create a toplevel widget, the frame strut should be dirty
+        data.fstrut_dirty = 1;
+
+    } else {
+        // non-toplevel widgets don't have a frame, so no need to
+        // update the strut
+        data.fstrut_dirty = 0;
+    }
+
+    if (initializeWindow && (popup || (topLevel && !desktop))) { // properties set on all toplevel windows
         // set _NET_WM_PID
         long curr_pid = getpid();
         XChangeProperty(dpy, id, ATOM(_NET_WM_PID), XA_CARDINAL, 32, PropModeReplace,
                         (unsigned char *) &curr_pid, 1);
 
-        // when we create a toplevel widget, the frame strut should be dirty
-        data.fstrut_dirty = 1;
 
         // declare the widget's window role
+        QByteArray windowRole;
         if (QTLWExtra *topData = maybeTopData()) {
-            if (!topData->role.isEmpty()) {
-                QByteArray windowRole = topData->role.toUtf8();
-                XChangeProperty(dpy, id,
-                                ATOM(WM_WINDOW_ROLE), XA_STRING, 8, PropModeReplace,
-                                (unsigned char *)windowRole.constData(), windowRole.length());
-            }
+            if (!topData->role.isEmpty())
+                windowRole = topData->role.toUtf8();
+        }
+        if (windowRole.isEmpty()) // use object name as a fallback
+            windowRole = objectName.toUtf8();
+        if (!windowRole.isEmpty()) {
+            XChangeProperty(dpy, id,
+                            ATOM(WM_WINDOW_ROLE), XA_STRING, 8, PropModeReplace,
+                            (unsigned char *)windowRole.constData(), windowRole.length());
         }
 
         // set client leader property
         XChangeProperty(dpy, id, ATOM(WM_CLIENT_LEADER),
                         XA_WINDOW, 32, PropModeReplace,
                         (unsigned char *)&X11->wm_client_leader, 1);
-    } else {
-        // non-toplevel widgets don't have a frame, so no need to
-        // update the strut
-        data.fstrut_dirty = 0;
     }
 
     if (initializeWindow && q->internalWinId()) {
@@ -2919,6 +2932,17 @@ void QWidgetPrivate::setWindowRole()
                     (unsigned char *)windowRole.constData(), windowRole.length());
 }
 
+void QWidgetPrivate::checkWindowRole()
+{
+    Q_Q(QWidget);
+    if( !q->windowRole().isEmpty() || !q->internalWinId())
+        return;
+    QByteArray windowRole = objectName.toUtf8(); // use as a fallback
+    XChangeProperty(X11->display, q->internalWinId(),
+                    ATOM(WM_WINDOW_ROLE), XA_STRING, 8, PropModeReplace,
+                    (unsigned char *)windowRole.constData(), windowRole.length());
+}
+
 Q_GLOBAL_STATIC(QX11PaintEngine, qt_widget_paintengine)
 QPaintEngine *QWidget::paintEngine() const
 {
diff --git a/src/gui/painting/qdrawhelper_p.h b/src/gui/painting/qdrawhelper_p.h
index 1968210..6737386 100644
--- a/src/gui/painting/qdrawhelper_p.h
+++ b/src/gui/painting/qdrawhelper_p.h
@@ -69,7 +69,7 @@
 
 // Disable MMX and SSE on Mac/PPC builds, or if the compiler
 // does not support -Xarch argument passing
-#if defined(QT_NO_MAC_XARCH) || (defined(Q_OS_DARWIN) && (defined(__ppc__) || defined(__ppc64__)))
+#if defined(QT_NO_MAC_XARCH) || ((defined(Q_OS_DARWIN) || defined(Q_OS_MAC)) && (defined(__ppc__) || defined(__ppc64__)))
 #undef QT_HAVE_SSE2
 #undef QT_HAVE_SSE
 #undef QT_HAVE_3DNOW
diff --git a/src/gui/widgets/qtabbar.cpp b/src/gui/widgets/qtabbar.cpp
index 30f6144..36dfe6d 100644
--- a/src/gui/widgets/qtabbar.cpp
+++ b/src/gui/widgets/qtabbar.cpp
@@ -678,8 +678,8 @@ void QTabBarPrivate::refresh()
         layoutTabs();
         makeVisible(currentIndex);
         q->update();
-        q->updateGeometry();
     }
+    q->updateGeometry();
 }
 
 /*!
diff --git a/src/multimedia/audio/qaudiodevicefactory.cpp b/src/multimedia/audio/qaudiodevicefactory.cpp
index e7fd425..646473c 100644
--- a/src/multimedia/audio/qaudiodevicefactory.cpp
+++ b/src/multimedia/audio/qaudiodevicefactory.cpp
@@ -49,7 +49,7 @@
 #include "qaudiodeviceinfo_win32_p.h"
 #include "qaudiooutput_win32_p.h"
 #include "qaudioinput_win32_p.h"
-#elif defined(Q_OS_MAC)
+#elif defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
 #include "qaudiodeviceinfo_mac_p.h"
 #include "qaudiooutput_mac_p.h"
 #include "qaudioinput_mac_p.h"
@@ -125,7 +125,7 @@ public:
 QList<QAudioDeviceInfo> QAudioDeviceFactory::availableDevices(QAudio::Mode mode)
 {
     QList<QAudioDeviceInfo> devices;
-#if (defined(Q_OS_WIN) || defined(Q_OS_MAC) || defined(HAS_ALSA))
+#if (defined(Q_OS_WIN) || defined(Q_OS_DARWIN) || defined(Q_OS_MAC) || defined(HAS_ALSA))
     foreach (const QByteArray &handle, QAudioDeviceInfoInternal::availableDevices(mode))
         devices << QAudioDeviceInfo(QLatin1String("builtin"), handle, mode);
 #endif
@@ -153,7 +153,7 @@ QAudioDeviceInfo QAudioDeviceFactory::defaultInputDevice()
         if (list.size() > 0)
             return QAudioDeviceInfo(QLatin1String("default"), list.at(0), QAudio::AudioInput);
     }
-#if (defined(Q_OS_WIN) || defined(Q_OS_MAC) || defined(HAS_ALSA))
+#if (defined(Q_OS_WIN) || defined(Q_OS_DARWIN) || defined(Q_OS_MAC) || defined(HAS_ALSA))
     return QAudioDeviceInfo(QLatin1String("builtin"), QAudioDeviceInfoInternal::defaultInputDevice(), QAudio::AudioInput);
 #endif
     return QAudioDeviceInfo();
@@ -168,7 +168,7 @@ QAudioDeviceInfo QAudioDeviceFactory::defaultOutputDevice()
         if (list.size() > 0)
             return QAudioDeviceInfo(QLatin1String("default"), list.at(0), QAudio::AudioOutput);
     }
-#if (defined(Q_OS_WIN) || defined(Q_OS_MAC) || defined(HAS_ALSA))
+#if (defined(Q_OS_WIN) || defined(Q_OS_DARWIN) || defined(Q_OS_MAC) || defined(HAS_ALSA))
     return QAudioDeviceInfo(QLatin1String("builtin"), QAudioDeviceInfoInternal::defaultOutputDevice(), QAudio::AudioOutput);
 #endif
     return QAudioDeviceInfo();
@@ -178,7 +178,7 @@ QAbstractAudioDeviceInfo* QAudioDeviceFactory::audioDeviceInfo(const QString &re
 {
     QAbstractAudioDeviceInfo *rc = 0;
 
-#if (defined(Q_OS_WIN) || defined(Q_OS_MAC) || defined(HAS_ALSA))
+#if (defined(Q_OS_WIN) || defined(Q_OS_DARWIN) || defined(Q_OS_MAC) || defined(HAS_ALSA))
     if (realm == QLatin1String("builtin"))
         return new QAudioDeviceInfoInternal(handle, mode);
 #endif
@@ -205,7 +205,7 @@ QAbstractAudioInput* QAudioDeviceFactory::createInputDevice(QAudioDeviceInfo con
 {
     if (deviceInfo.isNull())
         return new QNullInputDevice();
-#if (defined(Q_OS_WIN) || defined(Q_OS_MAC) || defined(HAS_ALSA))
+#if (defined(Q_OS_WIN) || defined(Q_OS_DARWIN) || defined(Q_OS_MAC) || defined(HAS_ALSA))
     if (deviceInfo.realm() == QLatin1String("builtin"))
         return new QAudioInputPrivate(deviceInfo.handle(), format);
 #endif
@@ -222,7 +222,7 @@ QAbstractAudioOutput* QAudioDeviceFactory::createOutputDevice(QAudioDeviceInfo c
 {
     if (deviceInfo.isNull())
         return new QNullOutputDevice();
-#if (defined(Q_OS_WIN) || defined(Q_OS_MAC) || defined(HAS_ALSA))
+#if (defined(Q_OS_WIN) || defined(Q_OS_DARWIN) || defined(Q_OS_MAC) || defined(HAS_ALSA))
     if (deviceInfo.realm() == QLatin1String("builtin"))
         return new QAudioOutputPrivate(deviceInfo.handle(), format);
 #endif
diff --git a/src/network/kernel/qhostinfo_unix.cpp b/src/network/kernel/qhostinfo_unix.cpp
index 2a05f05..933f6bc 100644
--- a/src/network/kernel/qhostinfo_unix.cpp
+++ b/src/network/kernel/qhostinfo_unix.cpp
@@ -148,7 +148,7 @@ QHostInfo QHostInfoAgent::fromName(const QString &hostName)
     if (address.setAddress(hostName)) {
         // Reverse lookup
 // Reverse lookups using getnameinfo are broken on darwin, use gethostbyaddr instead.
-#if !defined (QT_NO_GETADDRINFO) && !defined (Q_OS_DARWIN) && !defined (Q_OS_SYMBIAN)
+#if !defined (QT_NO_GETADDRINFO) && !defined (Q_OS_DARWIN) && !defined (Q_OS_MAC) && !defined (Q_OS_SYMBIAN)
         sockaddr_in sa4;
 #ifndef QT_NO_IPV6
         sockaddr_in6 sa6;
diff --git a/src/network/ssl/qsslsocket_openssl_symbols.cpp b/src/network/ssl/qsslsocket_openssl_symbols.cpp
index 86b94fc..5b6cade 100644
--- a/src/network/ssl/qsslsocket_openssl_symbols.cpp
+++ b/src/network/ssl/qsslsocket_openssl_symbols.cpp
@@ -320,7 +320,7 @@ static bool libGreaterThan(const QString &lhs, const QString &rhs)
 static QStringList findAllLibSsl()
 {
     QStringList paths;
-#  ifdef Q_OS_DARWIN
+#  if defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
     paths = QString::fromLatin1(qgetenv("DYLD_LIBRARY_PATH"))
             .split(QLatin1Char(':'), QString::SkipEmptyParts);
 #  else
diff --git a/src/qt3support/other/q3process_unix.cpp b/src/qt3support/other/q3process_unix.cpp
index 88cb73a..dde8a2a 100644
--- a/src/qt3support/other/q3process_unix.cpp
+++ b/src/qt3support/other/q3process_unix.cpp
@@ -790,7 +790,7 @@ bool Q3Process::start( QStringList *env )
 	} else { // start process with environment settins as specified in env
 	    // construct the environment for exec
 	    int numEntries = env->count();
-#if defined(Q_OS_MACX)
+#if defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
 	    QString ld_library_path(QLatin1String("DYLD_LIBRARY_PATH"));
 #else
 	    QString ld_library_path(QLatin1String("LD_LIBRARY_PATH"));
@@ -832,7 +832,7 @@ bool Q3Process::start( QStringList *env )
 			QFileInfo fileInfo( dir + QLatin1Char('/') + command );
 #endif
 			if ( fileInfo.isExecutable() ) {
-#if defined(Q_OS_MACX)
+#if defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
 			    arglistQ[0] = fileInfo.absFilePath().local8Bit();
 #else
 			    arglistQ[0] = fileInfo.filePath().local8Bit();
diff --git a/src/qt3support/qt3support.pro b/src/qt3support/qt3support.pro
index a30117c..c2e718b 100644
--- a/src/qt3support/qt3support.pro
+++ b/src/qt3support/qt3support.pro
@@ -26,6 +26,7 @@ unix {
    QMAKE_PKGCONFIG_REQUIRES = QtCore QtGui QtNetwork QtSql
 }
 mac:LIBS_PRIVATE += -framework Carbon
+darwin-*:LIBS += -lresolv
 
 QMAKE_LIBS += $$QMAKE_LIBS_COMPAT $$QMAKE_LIBS_NETWORK
 DEFINES -= QT3_SUPPORT_WARNINGS
diff --git a/src/qt3support/text/q3textedit.cpp b/src/qt3support/text/q3textedit.cpp
index 0d0e1a2..6887cec 100644
--- a/src/qt3support/text/q3textedit.cpp
+++ b/src/qt3support/text/q3textedit.cpp
@@ -4981,7 +4981,7 @@ void Q3TextEdit::pasteSubType(const QByteArray& subtype, QMimeSource *m)
 #if defined(Q_OS_WIN32)
         // Need to convert CRLF to LF
         t.replace(QLatin1String("\r\n"), QLatin1String("\n"));
-#elif defined(Q_OS_MAC)
+#elif defined(Q_OS_DARWIN) || defined(Q_OS_MAC)
         //need to convert CR to LF
         t.replace(QLatin1Char('\r'), QLatin1Char('\n'));
 #endif
diff --git a/src/sql/drivers/odbc/qsql_odbc.h b/src/sql/drivers/odbc/qsql_odbc.h
index 76627b8..4daf4d3 100644
--- a/src/sql/drivers/odbc/qsql_odbc.h
+++ b/src/sql/drivers/odbc/qsql_odbc.h
@@ -49,7 +49,7 @@
 #include <QtCore/qt_windows.h>
 #endif
 
-#if defined (Q_OS_MAC) && (MAC_OS_X_VERSION_MAX_ALLOWED <= MAC_OS_X_VERSION_10_3)
+#if (defined (Q_OS_DARWIN) || defined (Q_OS_MAC)) && (MAC_OS_X_VERSION_MAX_ALLOWED <= MAC_OS_X_VERSION_10_3)
 // assume we use iodbc on MACX
 // comment next line out if you use a
 // unicode compatible manager
diff --git a/src/testlib/qbenchmark_p.h b/src/testlib/qbenchmark_p.h
index e981646..d59a071 100644
--- a/src/testlib/qbenchmark_p.h
+++ b/src/testlib/qbenchmark_p.h
@@ -55,7 +55,7 @@
 
 #include <QtCore/qglobal.h>
 
-#if (defined(Q_OS_LINUX) || defined Q_OS_MAC) && !defined(QT_NO_PROCESS)
+#if (defined(Q_OS_LINUX) || defined (Q_OS_DARWIN) || defined(Q_OS_MAC)) && !defined(QT_NO_PROCESS)
 #define QTESTLIB_USE_VALGRIND 
 #else
 #undef QTESTLIB_USE_VALGRIND
diff --git a/src/tools/moc/main.cpp b/src/tools/moc/main.cpp
index 8e033b7..b5b2edd 100644
--- a/src/tools/moc/main.cpp
+++ b/src/tools/moc/main.cpp
@@ -94,7 +94,13 @@ static QByteArray combinePath(const char *infile, const char *outfile)
         inSplitted.prepend(QLatin1String(".."));
     }
     inSplitted.append(inFileInfo.fileName());
+#ifdef Q_WS_WIN
+    const QString rel = inSplitted.join(QLatin1String("/"));
+    const QString abs = inFileInfo.absoluteFilePath();
+    return QFile::encodeName(rel.length() < abs.length() ? rel : abs);
+#else
     return QFile::encodeName(inSplitted.join(QLatin1String("/")));
+#endif
 }
 
 
diff --git a/tools/assistant/lib/fulltextsearch/qclucene-config_p.h b/tools/assistant/lib/fulltextsearch/qclucene-config_p.h
index ffa5f5d..3a20995 100644
--- a/tools/assistant/lib/fulltextsearch/qclucene-config_p.h
+++ b/tools/assistant/lib/fulltextsearch/qclucene-config_p.h
@@ -354,7 +354,7 @@ configure.
 #endif
 
 #if !defined(__SUNPRO_CC) && !defined(__SUNPRO_C) && !defined(__MINGW32__) && \
-    !defined(Q_OS_MAC) && !defined(__HP_aCC)
+    !defined(Q_OS_DARWIN) && !defined(Q_OS_MAC) && !defined(__HP_aCC)
     /* Define to 1 if you have the `wcscasecmp' function. */
 #   ifndef _CL_HAVE_WCSCASECMP
 #   define _CL_HAVE_WCSCASECMP  1
diff --git a/tools/designer/src/plugins/plugins.pro b/tools/designer/src/plugins/plugins.pro
index baf5261..9f3a4ce 100644
--- a/tools/designer/src/plugins/plugins.pro
+++ b/tools/designer/src/plugins/plugins.pro
@@ -1,5 +1,7 @@
 TEMPLATE = subdirs
 CONFIG += ordered
+CONFIG -= lib_bundle
+QT_CONFIG -= qt_framework
 
 REQUIRES = !CONFIG(static,shared|static)
 contains(QT_CONFIG, qt3support): SUBDIRS += widgets
